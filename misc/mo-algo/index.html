



<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
        <meta name="description" content="AI Wiki 是一个编程竞赛知识整合站点，提供有趣又实用的编程竞赛知识以及其他有帮助的内容，帮助广大编程竞赛爱好者更快更深入地学习编程竞赛">
      
      
        <link rel="canonical" href="https://hai5g.cn/aiwiki/misc/mo-algo/">
      
      
        <meta name="author" content="AI Wiki Team">
      
      
        <meta name="lang:clipboard.copy" content="复制">
      
        <meta name="lang:clipboard.copied" content="已复制">
      
        <meta name="lang:search.language" content="jp">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="没有找到符合条件的结果">
      
        <meta name="lang:search.result.one" content="找到 1 个符合条件的结果">
      
        <meta name="lang:search.result.other" content="# 个符合条件的结果">
      
        <meta name="lang:search.tokenizer" content="[\uff0c\u3002]+">
      
      <link rel="shortcut icon" href="../../favicon.ico">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-4.2.0">
    
    
      
        <title>莫队算法 - AI Wiki</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/application.750b69bd.css">
      
        <link rel="stylesheet" href="../../assets/stylesheets/application-palette.224b79ff.css">
      
      
        
        
        <meta name="theme-color" content="">
      
    
    
      <script src="../../assets/javascripts/modernizr.74668098.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Fira+Sans:300,400,400i,700|Fira+Mono">
        <style>body,input{font-family:"Fira Sans","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Fira Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../../assets/fonts/material-icons.css">
    
      <link rel="manifest" href="../../manifest.webmanifest">
    
    
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ah@1.5.0/han.min.css">
    
      <link rel="stylesheet" href="../../_static/css/extra.css?v=11">
    
    
      
    
    
  </head>
  
    
    
    <body dir="ltr" data-md-color-primary="white" data-md-color-accent="red">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448"
    viewBox="0 0 416 448" id="__github">
  <path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19-18.125
        8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19 18.125-8.5
        18.125 8.5 10.75 19 3.125 20.5zM320 304q0 10-3.125 20.5t-10.75
        19-18.125 8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19
        18.125-8.5 18.125 8.5 10.75 19 3.125 20.5zM360
        304q0-30-17.25-51t-46.75-21q-10.25 0-48.75 5.25-17.75 2.75-39.25
        2.75t-39.25-2.75q-38-5.25-48.75-5.25-29.5 0-46.75 21t-17.25 51q0 22 8
        38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0
        37.25-1.75t35-7.375 30.5-15 20.25-25.75 8-38.375zM416 260q0 51.75-15.25
        82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5-41.75
        1.125q-19.5 0-35.5-0.75t-36.875-3.125-38.125-7.5-34.25-12.875-30.25-20.25-21.5-28.75q-15.5-30.75-15.5-82.75
        0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25
        30.875q36.75-8.75 77.25-8.75 37 0 70 8 26.25-20.5
        46.75-30.25t47.25-9.75q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34
        99.5z" />
</svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#_1" tabindex="1" class="md-skip">
        跳转至
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="https://hai5g.cn/aiwiki" title="AI Wiki" class="md-header-nav__button md-logo">
          
            <i class="md-icon">school</i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            <span class="md-header-nav__topic">
              AI Wiki
            </span>
            <span class="md-header-nav__topic">
              莫队算法
            </span>
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            键入以开始搜索
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  

<a href="https://github.com/myourdream/aiwiki/" title="前往 Github 仓库" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    aiwiki
  </div>
</a>
          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
        

  

<nav class="md-tabs md-tabs--active" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../.." title="简介" class="md-tabs__link">
          简介
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../../Coursera_ML_AndrewNg/markdown/SUMMARY/" title="Machine Learning" class="md-tabs__link">
          Machine Learning
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../../qa500/" title="深度学习500问" class="md-tabs__link">
          深度学习500问
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../../lihang/" title="统计学习" class="md-tabs__link">
          统计学习
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../../string/" title="集成学习算法" class="md-tabs__link">
          集成学习算法
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../../math/" title="CNN" class="md-tabs__link">
          CNN
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../../ds/" title="RNN" class="md-tabs__link">
          RNN
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../../graph/" title="GAN" class="md-tabs__link">
          GAN
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../../geometry/" title="计算机视觉" class="md-tabs__link">
          计算机视觉
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../" title="NLP" class="md-tabs__link">
          NLP
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../" title="推荐系统" class="md-tabs__link md-tabs__link--active">
          推荐系统
        </a>
      
    </li>
  

      
        
      
    </ul>
  </div>
</nav>
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="https://hai5g.cn/aiwiki" title="AI Wiki" class="md-nav__button md-logo">
      
        <i class="md-icon">school</i>
      
    </a>
    AI Wiki
  </label>
  
    <div class="md-nav__source">
      


  

<a href="https://github.com/myourdream/aiwiki/" title="前往 Github 仓库" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    aiwiki
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-1" type="checkbox" id="nav-1">
    
    <label class="md-nav__link" for="nav-1">
      简介
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-1">
        简介
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../.." title="Getting Started" class="md-nav__link">
      Getting Started
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../intro/AI学习路线/" title="AI学习路线" class="md-nav__link">
      AI学习路线
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../intro/mode/" title="AI 赛事与赛制" class="md-nav__link">
      AI 赛事与赛制
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../intro/icpc/" title="ICPC/CCPC 赛事与赛制" class="md-nav__link">
      ICPC/CCPC 赛事与赛制
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../intro/resources/" title="学习资源" class="md-nav__link">
      学习资源
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../intro/common-mistakes/" title="常见错误" class="md-nav__link">
      常见错误
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../intro/common-tricks/" title="常见技巧" class="md-nav__link">
      常见技巧
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../intro/non-traditional/" title="非传统题" class="md-nav__link">
      非传统题
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-1-9" type="checkbox" id="nav-1-9">
    
    <label class="md-nav__link" for="nav-1-9">
      工具软件
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-1-9">
        工具软件
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../intro/judgers/" title="评测工具" class="md-nav__link">
      评测工具
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../intro/editors/" title="编辑工具" class="md-nav__link">
      编辑工具
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../intro/wsl/" title="WSL (Windows 10)" class="md-nav__link">
      WSL (Windows 10)
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../intro/spj/" title="Special Judge" class="md-nav__link">
      Special Judge
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-1-9-5" type="checkbox" id="nav-1-9-5">
    
    <label class="md-nav__link" for="nav-1-9-5">
      Testlib
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-1-9-5">
        Testlib
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../intro/testlib/" title="Testlib 简介" class="md-nav__link">
      Testlib 简介
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../intro/testlib/general/" title="通用" class="md-nav__link">
      通用
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../intro/testlib/generator/" title="Generator" class="md-nav__link">
      Generator
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../intro/testlib/validator/" title="Validator" class="md-nav__link">
      Validator
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../intro/testlib/interactor/" title="Interactor" class="md-nav__link">
      Interactor
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../intro/testlib/checker/" title="Checker" class="md-nav__link">
      Checker
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../intro/docker-deploy/" title="Docker 部署" class="md-nav__link">
      Docker 部署
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../intro/about/" title="关于本项目" class="md-nav__link">
      关于本项目
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../intro/faq/" title="F.A.Q." class="md-nav__link">
      F.A.Q.
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2">
    
    <label class="md-nav__link" for="nav-2">
      Machine Learning
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        Machine Learning
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../Coursera_ML_AndrewNg/markdown/SUMMARY/" title="简介" class="md-nav__link">
      简介
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../Coursera_ML_AndrewNg/markdown/math/" title="数学基础" class="md-nav__link">
      数学基础
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../Coursera_ML_AndrewNg/markdown/week1/" title="week1" class="md-nav__link">
      week1
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../Coursera_ML_AndrewNg/markdown/week2/" title="week2" class="md-nav__link">
      week2
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../Coursera_ML_AndrewNg/markdown/week3/" title="week3" class="md-nav__link">
      week3
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../Coursera_ML_AndrewNg/markdown/week4/" title="week4" class="md-nav__link">
      week4
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../Coursera_ML_AndrewNg/markdown/week5/" title="week5" class="md-nav__link">
      week5
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../Coursera_ML_AndrewNg/markdown/week6/" title="week6" class="md-nav__link">
      week6
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../Coursera_ML_AndrewNg/markdown/week7/" title="week7" class="md-nav__link">
      week7
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../Coursera_ML_AndrewNg/markdown/week8/" title="week8" class="md-nav__link">
      week8
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../Coursera_ML_AndrewNg/markdown/week9/" title="week9" class="md-nav__link">
      week9
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../Coursera_ML_AndrewNg/markdown/week10/" title="week10" class="md-nav__link">
      week10
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3">
    
    <label class="md-nav__link" for="nav-3">
      深度学习500问
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        深度学习500问
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../qa500/" title="简介" class="md-nav__link">
      简介
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../qa500/content/" title="目录" class="md-nav__link">
      目录
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../qa500/ch01_math/ch01_math/" title="第一章_数学基础" class="md-nav__link">
      第一章_数学基础
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../qa500/ch02_机器学习基础/第二章_机器学习基础/" title="第二章_机器学习基础" class="md-nav__link">
      第二章_机器学习基础
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../qa500/ch03_深度学习基础/第三章_深度学习基础/" title="第三章_深度学习基础" class="md-nav__link">
      第三章_深度学习基础
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../qa500/ch04_经典网络/第四章_经典网络/" title="第四章_经典网络" class="md-nav__link">
      第四章_经典网络
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../qa500/ch05_卷积神经网络(CNN)/第五章 卷积神经网络（CNN）/" title="第五章 卷积神经网络（CNN）" class="md-nav__link">
      第五章 卷积神经网络（CNN）
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../qa500/ch06_循环神经网络(RNN)/第六章_循环神经网络(RNN)/" title="第六章_循环神经网络(RNN)" class="md-nav__link">
      第六章_循环神经网络(RNN)
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../qa500/ch07_生成对抗网络(GAN)/ch7/" title="第七章_生成对抗网络(GAN)" class="md-nav__link">
      第七章_生成对抗网络(GAN)
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../qa500/ch08_目标检测/第八章_目标检测/" title="第八章_目标检测" class="md-nav__link">
      第八章_目标检测
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../qa500/ch09_图像分割/第九章_图像分割/" title="第九章_图像分割" class="md-nav__link">
      第九章_图像分割
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../qa500/ch10_强化学习/第十章_强化学习/" title="第十章_强化学习" class="md-nav__link">
      第十章_强化学习
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../qa500/ch11_迁移学习/第十一章_迁移学习/" title="第十一章_迁移学习" class="md-nav__link">
      第十一章_迁移学习
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../qa500/ch12_网络搭建及训练/第十二章_网络搭建及训练/" title="第十二章_网络搭建及训练" class="md-nav__link">
      第十二章_网络搭建及训练
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../qa500/ch13_优化算法/第十三章_优化算法/" title="第十三章_优化算法" class="md-nav__link">
      第十三章_优化算法
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../qa500/ch14_超参数调整/第十四章_超参数调整/" title="第十四章_超参数调整" class="md-nav__link">
      第十四章_超参数调整
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../qa500/ch15_GPU和框架选型/第十五章_异构运算、GPU及框架选型/" title="第十五章_异构运算、GPU及框架选型" class="md-nav__link">
      第十五章_异构运算、GPU及框架选型
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../qa500/ch16_自然语言处理(NLP)/第十六章_NLP/" title="第十六章_NLP" class="md-nav__link">
      第十六章_NLP
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../qa500/ch17_模型压缩、加速及移动端部署/第十七章_模型压缩、加速及移动端部署/" title="第十七章_模型压缩、加速及移动端部署" class="md-nav__link">
      第十七章_模型压缩、加速及移动端部署
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../qa500/ch18_后端架构选型、离线及实时计算/第十八章_后端架构选型、离线及实时计算/" title="第十八章_后端架构选型、离线及实时计算" class="md-nav__link">
      第十八章_后端架构选型、离线及实时计算
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../qa500/ch18_后端架构选型及应用场景/第十八章_后端架构选型及应用场景/" title="第十八章_后端架构选型及应用场景" class="md-nav__link">
      第十八章_后端架构选型及应用场景
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4">
    
    <label class="md-nav__link" for="nav-4">
      统计学习
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        统计学习
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../lihang/" title="简介" class="md-nav__link">
      简介
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../lihang/CH01/" title="统计学习及监督学习概论" class="md-nav__link">
      统计学习及监督学习概论
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../lihang/CH02/" title="感知机" class="md-nav__link">
      感知机
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../lihang/CH03/" title="K近邻法" class="md-nav__link">
      K近邻法
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../lihang/CH04/" title="朴素贝叶斯法" class="md-nav__link">
      朴素贝叶斯法
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../lihang/CH05/" title="决策树" class="md-nav__link">
      决策树
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../lihang/CH06/" title="逻辑斯蒂回归与最大熵模型" class="md-nav__link">
      逻辑斯蒂回归与最大熵模型
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../lihang/CH07/" title="支持向量机" class="md-nav__link">
      支持向量机
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../lihang/CH08/" title="提升方法" class="md-nav__link">
      提升方法
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../lihang/CH09/" title="EM算法及其推广" class="md-nav__link">
      EM算法及其推广
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../lihang/CH10/" title="隐马尔可夫模型" class="md-nav__link">
      隐马尔可夫模型
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../lihang/CH11/" title="条件随机场" class="md-nav__link">
      条件随机场
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../lihang/CH12/" title="监督学习方法总结" class="md-nav__link">
      监督学习方法总结
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../lihang/CH13/" title="无监督学习概论" class="md-nav__link">
      无监督学习概论
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../lihang/CH14/" title="聚类方法" class="md-nav__link">
      聚类方法
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../lihang/CH22/" title="无监督学习方法总结" class="md-nav__link">
      无监督学习方法总结
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5" type="checkbox" id="nav-5">
    
    <label class="md-nav__link" for="nav-5">
      集成学习算法
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-5">
        集成学习算法
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../string/" title="字符串部分简介" class="md-nav__link">
      字符串部分简介
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../string/lib-func/" title="标准库" class="md-nav__link">
      标准库
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../string/match/" title="字符串匹配" class="md-nav__link">
      字符串匹配
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../string/hash/" title="哈希" class="md-nav__link">
      哈希
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../string/prefix-function/" title="前缀函数与 KMP 算法" class="md-nav__link">
      前缀函数与 KMP 算法
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../string/trie/" title="字典树 (Trie)" class="md-nav__link">
      字典树 (Trie)
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../string/pam/" title="回文自动机" class="md-nav__link">
      回文自动机
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../string/sa/" title="后缀数组 (SA)" class="md-nav__link">
      后缀数组 (SA)
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../string/ac-automaton/" title="AC 自动机" class="md-nav__link">
      AC 自动机
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../string/sam/" title="后缀自动机 (SAM)" class="md-nav__link">
      后缀自动机 (SAM)
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../string/suffix-tree/" title="后缀树" class="md-nav__link">
      后缀树
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../string/manacher/" title="Manacher" class="md-nav__link">
      Manacher
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../string/minimal-string/" title="最小表示法" class="md-nav__link">
      最小表示法
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../string/z-function/" title="Z 函数（扩展 KMP）" class="md-nav__link">
      Z 函数（扩展 KMP）
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-6" type="checkbox" id="nav-6">
    
    <label class="md-nav__link" for="nav-6">
      CNN
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-6">
        CNN
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../math/" title="数学部分简介" class="md-nav__link">
      数学部分简介
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../math/base/" title="进制" class="md-nav__link">
      进制
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../math/bit/" title="位运算" class="md-nav__link">
      位运算
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../math/bignum/" title="高精度" class="md-nav__link">
      高精度
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../math/quick-pow/" title="快速幂" class="md-nav__link">
      快速幂
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-6-6" type="checkbox" id="nav-6-6">
    
    <label class="md-nav__link" for="nav-6-6">
      整除及其性质
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-6-6">
        整除及其性质
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../math/prime/" title="素数" class="md-nav__link">
      素数
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../math/gcd/" title="最大公约数" class="md-nav__link">
      最大公约数
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../math/euler/" title="欧拉函数" class="md-nav__link">
      欧拉函数
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../math/sieve/" title="筛法" class="md-nav__link">
      筛法
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../math/fermat/" title="费马小定理" class="md-nav__link">
      费马小定理
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-6-7" type="checkbox" id="nav-6-7">
    
    <label class="md-nav__link" for="nav-6-7">
      同余方程相关
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-6-7">
        同余方程相关
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../math/bezouts/" title="裴蜀定理" class="md-nav__link">
      裴蜀定理
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../math/inverse/" title="乘法逆元" class="md-nav__link">
      乘法逆元
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../math/linear-equation/" title="线性同余方程" class="md-nav__link">
      线性同余方程
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../math/crt/" title="中国剩余定理" class="md-nav__link">
      中国剩余定理
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../math/bsgs/" title="BSGS" class="md-nav__link">
      BSGS
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../math/primitive-root/" title="原根" class="md-nav__link">
      原根
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-6-8" type="checkbox" id="nav-6-8">
    
    <label class="md-nav__link" for="nav-6-8">
      线性代数
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-6-8">
        线性代数
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../math/matrix/" title="矩阵" class="md-nav__link">
      矩阵
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../math/gauss/" title="高斯消元" class="md-nav__link">
      高斯消元
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../math/basis/" title="线性基" class="md-nav__link">
      线性基
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../math/complex/" title="复数" class="md-nav__link">
      复数
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../math/dictionary/" title="分段打表" class="md-nav__link">
      分段打表
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-6-11" type="checkbox" id="nav-6-11">
    
    <label class="md-nav__link" for="nav-6-11">
      数论函数相关
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-6-11">
        数论函数相关
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../math/mobius/" title="莫比乌斯反演" class="md-nav__link">
      莫比乌斯反演
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../math/du-sieves/" title="杜教筛" class="md-nav__link">
      杜教筛
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-6-12" type="checkbox" id="nav-6-12">
    
    <label class="md-nav__link" for="nav-6-12">
      多项式
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-6-12">
        多项式
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../math/poly/intro/" title="多项式部分简介" class="md-nav__link">
      多项式部分简介
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../math/poly/lagrange-poly/" title="拉格朗日插值" class="md-nav__link">
      拉格朗日插值
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../math/poly/fft/" title="快速傅里叶变换" class="md-nav__link">
      快速傅里叶变换
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../math/poly/ntt/" title="快速数论变换" class="md-nav__link">
      快速数论变换
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../math/poly/fwt/" title="快速沃尔什变换" class="md-nav__link">
      快速沃尔什变换
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../math/poly/inv/" title="多项式求逆" class="md-nav__link">
      多项式求逆
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../math/poly/sqrt/" title="多项式开方" class="md-nav__link">
      多项式开方
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../math/poly/div-mod/" title="多项式除法|取模" class="md-nav__link">
      多项式除法|取模
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../math/poly/ln-exp/" title="多项式对数函数|指数函数" class="md-nav__link">
      多项式对数函数|指数函数
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../math/poly/newton/" title="多项式牛顿迭代" class="md-nav__link">
      多项式牛顿迭代
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../math/poly/multipoint-eval-interpolation/" title="多项式多点求值|快速插值" class="md-nav__link">
      多项式多点求值|快速插值
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../math/poly/tri-func/" title="多项式三角函数" class="md-nav__link">
      多项式三角函数
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../math/poly/inv-tri-func/" title="多项式反三角函数" class="md-nav__link">
      多项式反三角函数
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-6-13" type="checkbox" id="nav-6-13">
    
    <label class="md-nav__link" for="nav-6-13">
      组合数学
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-6-13">
        组合数学
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../math/combination/" title="排列组合" class="md-nav__link">
      排列组合
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../math/catalan/" title="卡特兰数" class="md-nav__link">
      卡特兰数
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../math/stirling/" title="斯特林数" class="md-nav__link">
      斯特林数
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../math/cantor/" title="康托展开" class="md-nav__link">
      康托展开
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../math/inclusion-exclusion-principle/" title="容斥原理" class="md-nav__link">
      容斥原理
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../math/drawer-principle/" title="抽屉原理" class="md-nav__link">
      抽屉原理
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../math/expectation/" title="概率 & 期望" class="md-nav__link">
      概率 & 期望
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../math/permutation-group/" title="置换群" class="md-nav__link">
      置换群
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../math/integral/" title="数值积分" class="md-nav__link">
      数值积分
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../math/linear-programming/" title="线性规划" class="md-nav__link">
      线性规划
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../math/game-theory/" title="博弈论" class="md-nav__link">
      博弈论
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../math/misc/" title="杂项" class="md-nav__link">
      杂项
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-7" type="checkbox" id="nav-7">
    
    <label class="md-nav__link" for="nav-7">
      RNN
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-7">
        RNN
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../ds/" title="数据结构部分简介" class="md-nav__link">
      数据结构部分简介
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-7-2" type="checkbox" id="nav-7-2">
    
    <label class="md-nav__link" for="nav-7-2">
      STL
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-7-2">
        STL
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../ds/stl/" title="STL 简介" class="md-nav__link">
      STL 简介
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../ds/stl/vector/" title="vector" class="md-nav__link">
      vector
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../ds/stl/priority_queue/" title="priority_queue" class="md-nav__link">
      priority_queue
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../ds/stl/map/" title="map" class="md-nav__link">
      map
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../ds/stl/bitset/" title="bitset" class="md-nav__link">
      bitset
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-7-3" type="checkbox" id="nav-7-3">
    
    <label class="md-nav__link" for="nav-7-3">
      pb_ds
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-7-3">
        pb_ds
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../ds/pb-ds/" title="pb_ds 简介" class="md-nav__link">
      pb_ds 简介
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../ds/pb-ds/priority-queue/" title="__gnu_pbds::priority_queue" class="md-nav__link">
      __gnu_pbds::priority_queue
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../ds/stack/" title="栈" class="md-nav__link">
      栈
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../ds/queue/" title="队列" class="md-nav__link">
      队列
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../ds/linked-list/" title="链表" class="md-nav__link">
      链表
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../ds/hash/" title="哈希表" class="md-nav__link">
      哈希表
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../ds/dsu/" title="并查集" class="md-nav__link">
      并查集
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-7-9" type="checkbox" id="nav-7-9">
    
    <label class="md-nav__link" for="nav-7-9">
      堆
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-7-9">
        堆
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../ds/heap/" title="堆简介" class="md-nav__link">
      堆简介
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../ds/binary-heap/" title="二叉堆" class="md-nav__link">
      二叉堆
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../ds/pairing-heap/" title="配对堆" class="md-nav__link">
      配对堆
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-7-10" type="checkbox" id="nav-7-10">
    
    <label class="md-nav__link" for="nav-7-10">
      块状数据结构
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-7-10">
        块状数据结构
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../ds/square-root-decomposition/" title="分块思想" class="md-nav__link">
      分块思想
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../ds/block-list/" title="块状链表" class="md-nav__link">
      块状链表
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../ds/block-array/" title="块状数组" class="md-nav__link">
      块状数组
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../ds/tree-decompose/" title="树分块" class="md-nav__link">
      树分块
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../ds/monotonous-stack/" title="单调栈" class="md-nav__link">
      单调栈
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../ds/monotonous-queue/" title="单调队列" class="md-nav__link">
      单调队列
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../ds/sparse-table/" title="倍增" class="md-nav__link">
      倍增
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../ds/bit/" title="树状数组" class="md-nav__link">
      树状数组
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../ds/segment/" title="线段树" class="md-nav__link">
      线段树
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../ds/dividing/" title="划分树" class="md-nav__link">
      划分树
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-7-17" type="checkbox" id="nav-7-17">
    
    <label class="md-nav__link" for="nav-7-17">
      平衡树
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-7-17">
        平衡树
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../ds/bst/" title="二叉搜索树简介" class="md-nav__link">
      二叉搜索树简介
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../ds/treap/" title="Treap" class="md-nav__link">
      Treap
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../ds/splay/" title="Splay" class="md-nav__link">
      Splay
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../ds/wblt/" title="WBLT" class="md-nav__link">
      WBLT
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../ds/sbt/" title="Size Balanced Tree" class="md-nav__link">
      Size Balanced Tree
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../ds/avl/" title="AVL 树" class="md-nav__link">
      AVL 树
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../ds/scapegoat/" title="替罪羊树" class="md-nav__link">
      替罪羊树
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-7-18" type="checkbox" id="nav-7-18">
    
    <label class="md-nav__link" for="nav-7-18">
      树套树
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-7-18">
        树套树
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../ds/seg-in-seg/" title="线段树套线段树" class="md-nav__link">
      线段树套线段树
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../ds/seg-in-balanced/" title="平衡树套线段树" class="md-nav__link">
      平衡树套线段树
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../ds/balanced-in-seg/" title="线段树套平衡树" class="md-nav__link">
      线段树套平衡树
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../ds/persistent-in-bit/" title="树状数组套主席树" class="md-nav__link">
      树状数组套主席树
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../ds/k-dtree/" title="K-Dtree" class="md-nav__link">
      K-Dtree
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-7-20" type="checkbox" id="nav-7-20">
    
    <label class="md-nav__link" for="nav-7-20">
      可持久化数据结构
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-7-20">
        可持久化数据结构
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../ds/persistent/" title="可持久化数据结构简介" class="md-nav__link">
      可持久化数据结构简介
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../ds/persistent-seg/" title="可持久化线段树" class="md-nav__link">
      可持久化线段树
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../ds/persistent-block-array/" title="可持久化块状数组" class="md-nav__link">
      可持久化块状数组
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../ds/persistent-balanced/" title="可持久化平衡树" class="md-nav__link">
      可持久化平衡树
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../ds/persistent-trie/" title="可持久化字典树" class="md-nav__link">
      可持久化字典树
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../ds/odt/" title="珂朵莉树" class="md-nav__link">
      珂朵莉树
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../ds/lct/" title="Link Cut Tree" class="md-nav__link">
      Link Cut Tree
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../ds/ett/" title="Euler Tour Tree" class="md-nav__link">
      Euler Tour Tree
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-8" type="checkbox" id="nav-8">
    
    <label class="md-nav__link" for="nav-8">
      GAN
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-8">
        GAN
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../graph/" title="图论部分简介" class="md-nav__link">
      图论部分简介
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../graph/basic/" title="图论基础" class="md-nav__link">
      图论基础
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../graph/traverse/" title="图的遍历" class="md-nav__link">
      图的遍历
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-8-4" type="checkbox" id="nav-8-4">
    
    <label class="md-nav__link" for="nav-8-4">
      树上问题
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-8-4">
        树上问题
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../graph/tree-basic/" title="树基础" class="md-nav__link">
      树基础
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../graph/lca/" title="最近公共祖先" class="md-nav__link">
      最近公共祖先
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../graph/dfs-order/" title="DFS 序" class="md-nav__link">
      DFS 序
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../graph/tree-misc/" title="树的其他问题" class="md-nav__link">
      树的其他问题
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../graph/tree-hash/" title="树哈希" class="md-nav__link">
      树哈希
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../graph/heavy-light-decomposition/" title="树链剖分" class="md-nav__link">
      树链剖分
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../graph/tree-divide/" title="树分治" class="md-nav__link">
      树分治
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../graph/dynamic-tree-divide/" title="动态树分治" class="md-nav__link">
      动态树分治
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../graph/virtual-tree/" title="虚树" class="md-nav__link">
      虚树
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../graph/dsu-on-tree/" title="树上启发式合并" class="md-nav__link">
      树上启发式合并
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../graph/matrix-tree/" title="矩阵树定理" class="md-nav__link">
      矩阵树定理
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../graph/dag/" title="有向无环图" class="md-nav__link">
      有向无环图
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../graph/topo/" title="拓扑排序" class="md-nav__link">
      拓扑排序
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../graph/mst/" title="最小生成树" class="md-nav__link">
      最小生成树
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../graph/mdst/" title="最小树形图" class="md-nav__link">
      最小树形图
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../graph/shortest-path/" title="最短路" class="md-nav__link">
      最短路
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../graph/differential-constraints/" title="差分约束" class="md-nav__link">
      差分约束
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../graph/kth-path/" title="k 短路" class="md-nav__link">
      k 短路
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-8-13" type="checkbox" id="nav-8-13">
    
    <label class="md-nav__link" for="nav-8-13">
      连通性相关
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-8-13">
        连通性相关
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../graph/scc/" title="强连通分量" class="md-nav__link">
      强连通分量
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../graph/bcc/" title="双连通分量" class="md-nav__link">
      双连通分量
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../graph/bridge/" title="割点和桥" class="md-nav__link">
      割点和桥
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../graph/2-sat/" title="2-SAT" class="md-nav__link">
      2-SAT
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../graph/euler/" title="欧拉图" class="md-nav__link">
      欧拉图
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../graph/hamilton/" title="哈密顿图" class="md-nav__link">
      哈密顿图
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../graph/bi-graph/" title="二分图" class="md-nav__link">
      二分图
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../graph/min-circle/" title="最小环" class="md-nav__link">
      最小环
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../graph/planar/" title="平面图" class="md-nav__link">
      平面图
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../graph/color/" title="图的着色" class="md-nav__link">
      图的着色
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-8-20" type="checkbox" id="nav-8-20">
    
    <label class="md-nav__link" for="nav-8-20">
      网络流
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-8-20">
        网络流
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../graph/flow/" title="网络流简介" class="md-nav__link">
      网络流简介
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../graph/flow/node/" title="拆点" class="md-nav__link">
      拆点
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../graph/flow/max-flow/" title="最大流" class="md-nav__link">
      最大流
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../graph/flow/min-cut/" title="最小割" class="md-nav__link">
      最小割
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../graph/flow/min-cost/" title="费用流" class="md-nav__link">
      费用流
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../graph/flow/bound/" title="上下界网络流" class="md-nav__link">
      上下界网络流
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../graph/misc/" title="图论杂项" class="md-nav__link">
      图论杂项
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-9" type="checkbox" id="nav-9">
    
    <label class="md-nav__link" for="nav-9">
      计算机视觉
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-9">
        计算机视觉
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../geometry/" title="计算几何部分简介" class="md-nav__link">
      计算几何部分简介
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../geometry/2d/" title="二维计算几何基础" class="md-nav__link">
      二维计算几何基础
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../geometry/3d/" title="三维计算几何基础" class="md-nav__link">
      三维计算几何基础
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../geometry/distance/" title="距离" class="md-nav__link">
      距离
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../geometry/pick/" title="Pick 定理" class="md-nav__link">
      Pick 定理
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../geometry/triangulation/" title="三角剖分" class="md-nav__link">
      三角剖分
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../geometry/convex-hull/" title="凸包" class="md-nav__link">
      凸包
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../geometry/scanning/" title="扫描线" class="md-nav__link">
      扫描线
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../geometry/rotating-calipers/" title="旋转卡壳" class="md-nav__link">
      旋转卡壳
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../geometry/half-plane-intersection/" title="半平面交" class="md-nav__link">
      半平面交
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../geometry/nearest-points/" title="平面最近点对" class="md-nav__link">
      平面最近点对
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../geometry/magic/" title="计算几何杂项" class="md-nav__link">
      计算几何杂项
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-10" type="checkbox" id="nav-10">
    
    <label class="md-nav__link" for="nav-10">
      NLP
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-10">
        NLP
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../" title="杂项简介" class="md-nav__link">
      杂项简介
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../io/" title="读入、输出优化" class="md-nav__link">
      读入、输出优化
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../complexity/" title="复杂度" class="md-nav__link">
      复杂度
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../discrete/" title="离散化" class="md-nav__link">
      离散化
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-10-5" type="checkbox" id="nav-10-5">
    
    <label class="md-nav__link" for="nav-10-5">
      离线算法
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-10-5">
        离线算法
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../offline/" title="离线算法简介" class="md-nav__link">
      离线算法简介
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../cdq-divide/" title="CDQ 分治" class="md-nav__link">
      CDQ 分治
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        莫队算法
      </label>
    
    <a href="./" title="莫队算法" class="md-nav__link md-nav__link--active">
      莫队算法
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
  
    <label class="md-nav__title" for="__toc">目录</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_1" title="普通莫队算法" class="md-nav__link">
    普通莫队算法
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_2" title="概述" class="md-nav__link">
    概述
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_3" title="形式" class="md-nav__link">
    形式
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_4" title="实现" class="md-nav__link">
    实现
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_5" title="排序方法" class="md-nav__link">
    排序方法
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_6" title="模板" class="md-nav__link">
    模板
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_7" title="复杂度分析" class="md-nav__link">
    复杂度分析
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_8" title="例题 &amp; 代码" class="md-nav__link">
    例题 &amp; 代码
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_9" title="普通莫队的优化" class="md-nav__link">
    普通莫队的优化
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_10" title="带修改" class="md-nav__link">
    带修改
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_11" title="特点" class="md-nav__link">
    特点
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_12" title="例题" class="md-nav__link">
    例题
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_13" title="树上莫队" class="md-nav__link">
    树上莫队
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_14" title="真·树上莫队" class="md-nav__link">
    真·树上莫队
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_15" title="询问的排序" class="md-nav__link">
    询问的排序
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_16" title="指针的移动" class="md-nav__link">
    指针的移动
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_17" title="时间复杂度" class="md-nav__link">
    时间复杂度
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#wc2013" title="[WC2013]糖果公园" class="md-nav__link">
    [WC2013]糖果公园
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
      
      
        <li class="md-nav__item">
          <a href="#__comments" title="评论" class="md-nav__link md-nav__link--active">
            评论
          </a>
        </li>
      
    </ul>
  
</nav>
    
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../fractional-programming/" title="分数规划" class="md-nav__link">
      分数规划
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-10-7" type="checkbox" id="nav-10-7">
    
    <label class="md-nav__link" for="nav-10-7">
      随机化
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-10-7">
        随机化
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../random/" title="随机函数" class="md-nav__link">
      随机函数
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../hill-climbing/" title="爬山算法" class="md-nav__link">
      爬山算法
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../simulated-annealing/" title="模拟退火" class="md-nav__link">
      模拟退火
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../random-incremental/" title="随机增量法" class="md-nav__link">
      随机增量法
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../largest-matrix/" title="悬线法" class="md-nav__link">
      悬线法
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../cc-basic/" title="计算理论基础" class="md-nav__link">
      计算理论基础
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../endianness/" title="字节顺序" class="md-nav__link">
      字节顺序
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-11" type="checkbox" id="nav-11" checked>
    
    <label class="md-nav__link" for="nav-11">
      推荐系统
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-11">
        推荐系统
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../" title="杂项简介" class="md-nav__link">
      杂项简介
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../io/" title="读入、输出优化" class="md-nav__link">
      读入、输出优化
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../complexity/" title="复杂度" class="md-nav__link">
      复杂度
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../discrete/" title="离散化" class="md-nav__link">
      离散化
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-11-5" type="checkbox" id="nav-11-5" checked>
    
    <label class="md-nav__link" for="nav-11-5">
      离线算法
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-11-5">
        离线算法
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../offline/" title="离线算法简介" class="md-nav__link">
      离线算法简介
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../cdq-divide/" title="CDQ 分治" class="md-nav__link">
      CDQ 分治
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        莫队算法
      </label>
    
    <a href="./" title="莫队算法" class="md-nav__link md-nav__link--active">
      莫队算法
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
  
    <label class="md-nav__title" for="__toc">目录</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_1" title="普通莫队算法" class="md-nav__link">
    普通莫队算法
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_2" title="概述" class="md-nav__link">
    概述
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_3" title="形式" class="md-nav__link">
    形式
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_4" title="实现" class="md-nav__link">
    实现
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_5" title="排序方法" class="md-nav__link">
    排序方法
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_6" title="模板" class="md-nav__link">
    模板
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_7" title="复杂度分析" class="md-nav__link">
    复杂度分析
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_8" title="例题 &amp; 代码" class="md-nav__link">
    例题 &amp; 代码
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_9" title="普通莫队的优化" class="md-nav__link">
    普通莫队的优化
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_10" title="带修改" class="md-nav__link">
    带修改
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_11" title="特点" class="md-nav__link">
    特点
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_12" title="例题" class="md-nav__link">
    例题
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_13" title="树上莫队" class="md-nav__link">
    树上莫队
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_14" title="真·树上莫队" class="md-nav__link">
    真·树上莫队
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_15" title="询问的排序" class="md-nav__link">
    询问的排序
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_16" title="指针的移动" class="md-nav__link">
    指针的移动
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_17" title="时间复杂度" class="md-nav__link">
    时间复杂度
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#wc2013" title="[WC2013]糖果公园" class="md-nav__link">
    [WC2013]糖果公园
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
      
      
        <li class="md-nav__item">
          <a href="#__comments" title="评论" class="md-nav__link md-nav__link--active">
            评论
          </a>
        </li>
      
    </ul>
  
</nav>
    
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../fractional-programming/" title="分数规划" class="md-nav__link">
      分数规划
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-11-7" type="checkbox" id="nav-11-7">
    
    <label class="md-nav__link" for="nav-11-7">
      随机化
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-11-7">
        随机化
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../random/" title="随机函数" class="md-nav__link">
      随机函数
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../hill-climbing/" title="爬山算法" class="md-nav__link">
      爬山算法
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../simulated-annealing/" title="模拟退火" class="md-nav__link">
      模拟退火
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../random-incremental/" title="随机增量法" class="md-nav__link">
      随机增量法
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../largest-matrix/" title="悬线法" class="md-nav__link">
      悬线法
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../cc-basic/" title="计算理论基础" class="md-nav__link">
      计算理论基础
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../endianness/" title="字节顺序" class="md-nav__link">
      字节顺序
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../about/" title="关于" class="md-nav__link">
      关于
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
  
    <label class="md-nav__title" for="__toc">目录</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_1" title="普通莫队算法" class="md-nav__link">
    普通莫队算法
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_2" title="概述" class="md-nav__link">
    概述
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_3" title="形式" class="md-nav__link">
    形式
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_4" title="实现" class="md-nav__link">
    实现
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_5" title="排序方法" class="md-nav__link">
    排序方法
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_6" title="模板" class="md-nav__link">
    模板
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_7" title="复杂度分析" class="md-nav__link">
    复杂度分析
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_8" title="例题 &amp; 代码" class="md-nav__link">
    例题 &amp; 代码
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_9" title="普通莫队的优化" class="md-nav__link">
    普通莫队的优化
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_10" title="带修改" class="md-nav__link">
    带修改
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_11" title="特点" class="md-nav__link">
    特点
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_12" title="例题" class="md-nav__link">
    例题
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_13" title="树上莫队" class="md-nav__link">
    树上莫队
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_14" title="真·树上莫队" class="md-nav__link">
    真·树上莫队
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_15" title="询问的排序" class="md-nav__link">
    询问的排序
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_16" title="指针的移动" class="md-nav__link">
    指针的移动
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_17" title="时间复杂度" class="md-nav__link">
    时间复杂度
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#wc2013" title="[WC2013]糖果公园" class="md-nav__link">
    [WC2013]糖果公园
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
      
      
        <li class="md-nav__item">
          <a href="#__comments" title="评论" class="md-nav__link md-nav__link--active">
            评论
          </a>
        </li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/myourdream/aiwiki/blob/master/docs/misc/mo-algo.md" title="编辑此页" class="md-icon md-content__icon">&#xE3C9;</a>
                
                
                  <h1>莫队算法</h1>
                
                <h2 id="_1">普通莫队算法<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h2>
<p>（主要参考了<a href="https://blog.sengxian.com/algorithms/mo-s-algorithm">https://blog.sengxian.com/algorithms/mo-s-algorithm</a>。）</p>
<h3 id="_2">概述<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h3>
<p>莫队算法是由莫涛提出的算法，可以解决一类离线区间询问问题，适用性极为广泛。同时将其加以扩展，便能轻松处理树上路径询问以及支持修改操作。</p>
<h3 id="_3">形式<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h3>
<p>假设 <span><span class="MathJax_Preview">n=m</span><script type="math/tex">n=m</script></span> ，那么对于序列上的区间询问问题，如果从 <span><span class="MathJax_Preview">[l,r]</span><script type="math/tex">[l,r]</script></span> 的答案能够 <span><span class="MathJax_Preview">O(1)</span><script type="math/tex">O(1)</script></span> 扩展到 <span><span class="MathJax_Preview">[l-1,r],[l+1,r],[l,r+1],[l,r-1]</span><script type="math/tex">[l-1,r],[l+1,r],[l,r+1],[l,r-1]</script></span> （即与 <span><span class="MathJax_Preview">[l,r]</span><script type="math/tex">[l,r]</script></span> 相邻的区间）的答案，那么可以在 <span><span class="MathJax_Preview">O(n\sqrt{n})</span><script type="math/tex">O(n\sqrt{n})</script></span> 的复杂度内求出所有询问的答案。</p>
<h3 id="_4">实现<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h3>
<p>离线后排序，顺序处理每个询问，暴力从上一个区间的答案转移到下一个区间答案（一步一步移动即可）。</p>
<h3 id="_5">排序方法<a class="headerlink" href="#_5" title="Permanent link">&para;</a></h3>
<p>对于区间 <span><span class="MathJax_Preview">[l,r]</span><script type="math/tex">[l,r]</script></span> , 以 <span><span class="MathJax_Preview">l</span><script type="math/tex">l</script></span> 所在块的编号为第一关键字， <span><span class="MathJax_Preview">r</span><script type="math/tex">r</script></span> 为第二关键字从小到大排序。</p>
<h3 id="_6">模板<a class="headerlink" href="#_6" title="Permanent link">&para;</a></h3>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="kr">inline</span> <span class="kt">void</span> <span class="nf">move</span><span class="p">(</span><span class="kt">int</span> <span class="n">pos</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sign</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// update nowAns</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">solve</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">BLOCK_SIZE</span> <span class="o">=</span> <span class="kt">int</span><span class="p">(</span><span class="n">ceil</span><span class="p">(</span><span class="n">pow</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)));</span>
  <span class="n">sort</span><span class="p">(</span><span class="n">querys</span><span class="p">,</span> <span class="n">querys</span> <span class="o">+</span> <span class="n">m</span><span class="p">);</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">m</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">const</span> <span class="n">query</span> <span class="o">&amp;</span><span class="n">q</span> <span class="o">=</span> <span class="n">querys</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">l</span> <span class="o">&gt;</span> <span class="n">q</span><span class="p">.</span><span class="n">l</span><span class="p">)</span> <span class="n">move</span><span class="p">(</span><span class="o">--</span><span class="n">l</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">r</span> <span class="o">&lt;</span> <span class="n">q</span><span class="p">.</span><span class="n">r</span><span class="p">)</span> <span class="n">move</span><span class="p">(</span><span class="n">r</span><span class="o">++</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">l</span> <span class="o">&lt;</span> <span class="n">q</span><span class="p">.</span><span class="n">l</span><span class="p">)</span> <span class="n">move</span><span class="p">(</span><span class="n">l</span><span class="o">++</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">r</span> <span class="o">&gt;</span> <span class="n">q</span><span class="p">.</span><span class="n">r</span><span class="p">)</span> <span class="n">move</span><span class="p">(</span><span class="o">--</span><span class="n">r</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
    <span class="n">ans</span><span class="p">[</span><span class="n">q</span><span class="p">.</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">nowAns</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>

<h3 id="_7">复杂度分析<a class="headerlink" href="#_7" title="Permanent link">&para;</a></h3>
<p>以下的情况在 <span><span class="MathJax_Preview">n</span><script type="math/tex">n</script></span> 和 <span><span class="MathJax_Preview">m</span><script type="math/tex">m</script></span> 同阶的前提下讨论。</p>
<p>首先是分块这一步，这一步的时间复杂度毫无疑问地是 <span><span class="MathJax_Preview">O(\sqrt{n}\cdot\sqrt{n}\log\sqrt{n}+n\log n)=O(n\log n)</span><script type="math/tex">O(\sqrt{n}\cdot\sqrt{n}\log\sqrt{n}+n\log n)=O(n\log n)</script></span> ;</p>
<p>接着就到了莫队算法的精髓了，下面我们用通俗易懂的初中方法来证明它的时间复杂度是 <span><span class="MathJax_Preview">O(n\sqrt{n})</span><script type="math/tex">O(n\sqrt{n})</script></span> ；</p>
<p>证：令每一块中 <span><span class="MathJax_Preview">L</span><script type="math/tex">L</script></span> 的最大值为 <span><span class="MathJax_Preview">\max_1,\max_2,\max_3, \cdots , \max_{\lceil\sqrt{n}\rceil}</span><script type="math/tex">\max_1,\max_2,\max_3, \cdots , \max_{\lceil\sqrt{n}\rceil}</script></span> 。</p>
<p>由第一次排序可知， <span><span class="MathJax_Preview">\max_1 \le \max_2 \le \cdots \le \max_{\lceil\sqrt{n}\rceil}</span><script type="math/tex">\max_1 \le \max_2 \le \cdots \le \max_{\lceil\sqrt{n}\rceil}</script></span> 。</p>
<p>显然，对于每一块暴力求出第一个询问的时间复杂度为 <span><span class="MathJax_Preview">O(n)</span><script type="math/tex">O(n)</script></span> 。</p>
<p>考虑最坏的情况，在每一块中， <span><span class="MathJax_Preview">R</span><script type="math/tex">R</script></span> 的最大值均为 <span><span class="MathJax_Preview">n</span><script type="math/tex">n</script></span> ，每次修改操作均要将 <span><span class="MathJax_Preview">L</span><script type="math/tex">L</script></span> 由 <span><span class="MathJax_Preview">\max_{i - 1}</span><script type="math/tex">\max_{i - 1}</script></span> 修改至 <span><span class="MathJax_Preview">\max_i</span><script type="math/tex">\max_i</script></span> 或由 <span><span class="MathJax_Preview">\max_i</span><script type="math/tex">\max_i</script></span> 修改至 <span><span class="MathJax_Preview">\max_{i - 1}</span><script type="math/tex">\max_{i - 1}</script></span> 。</p>
<p>考虑 <span><span class="MathJax_Preview">R</span><script type="math/tex">R</script></span> ：因为 <span><span class="MathJax_Preview">R</span><script type="math/tex">R</script></span> 在块中已经排好序，所以在同一块修改完它的时间复杂度为 <span><span class="MathJax_Preview">O(n)</span><script type="math/tex">O(n)</script></span> 。对于所有块就是 <span><span class="MathJax_Preview">O(n\sqrt{n})</span><script type="math/tex">O(n\sqrt{n})</script></span> 。</p>
<p>重点分析 <span><span class="MathJax_Preview">L</span><script type="math/tex">L</script></span> ：因为每一次改变的时间复杂度都是 <span><span class="MathJax_Preview">O(\max_i-\max_{i-1})</span><script type="math/tex">O(\max_i-\max_{i-1})</script></span> 的，所以在同一块中时间复杂度为 <span><span class="MathJax_Preview">O(\sqrt{n}\cdot(\max_i-\max_{i-1}))</span><script type="math/tex">O(\sqrt{n}\cdot(\max_i-\max_{i-1}))</script></span> 。</p>
<p>将每一块 <span><span class="MathJax_Preview">L</span><script type="math/tex">L</script></span> 的时间复杂度合在一起，可以得到：</p>
<p>对于 <span><span class="MathJax_Preview">L</span><script type="math/tex">L</script></span> 的总时间复杂度为</p>
<div>
<div class="MathJax_Preview">
\begin{aligned}
&amp; O(\sqrt{n}(\max{}_1-1)+\sqrt{n}(\max{}_2-\max{}_1)+\sqrt{n}(\max{}_3-\max{}_2)+\cdots+\sqrt{n}(\max{}_{\lceil\sqrt{n}\rceil}-\max{}_{\lceil\sqrt{n}\rceil-1))} \\
= &amp; O(\sqrt{n}\cdot(\max{}_1-1+\max{}_2-\max{}_1+\max{}_3-\max{}_2+\cdots+\max{}_{\lceil\sqrt{n}\rceil-1}-\max{}_{\lceil\sqrt{n}\rceil-2}+\max{}_{\lceil\sqrt{n}\rceil}-\max{}_{\lceil\sqrt{n}\rceil-1)}) \\
= &amp; O(\sqrt{n}\cdot(\max{}_{\lceil\sqrt{n}\rceil-1}))\\
\end{aligned}
</div>
<script type="math/tex; mode=display">
\begin{aligned}
& O(\sqrt{n}(\max{}_1-1)+\sqrt{n}(\max{}_2-\max{}_1)+\sqrt{n}(\max{}_3-\max{}_2)+\cdots+\sqrt{n}(\max{}_{\lceil\sqrt{n}\rceil}-\max{}_{\lceil\sqrt{n}\rceil-1))} \\
= & O(\sqrt{n}\cdot(\max{}_1-1+\max{}_2-\max{}_1+\max{}_3-\max{}_2+\cdots+\max{}_{\lceil\sqrt{n}\rceil-1}-\max{}_{\lceil\sqrt{n}\rceil-2}+\max{}_{\lceil\sqrt{n}\rceil}-\max{}_{\lceil\sqrt{n}\rceil-1)}) \\
= & O(\sqrt{n}\cdot(\max{}_{\lceil\sqrt{n}\rceil-1}))\\
\end{aligned}
</script>
</div>
<p>（裂项求和）</p>
<p>由题可知 <span><span class="MathJax_Preview">\max_{\lceil\sqrt{n}\rceil}</span><script type="math/tex">\max_{\lceil\sqrt{n}\rceil}</script></span> 最大为 <span><span class="MathJax_Preview">n</span><script type="math/tex">n</script></span> ，所以 <span><span class="MathJax_Preview">L</span><script type="math/tex">L</script></span> 的总时间复杂度最坏情况下为 <span><span class="MathJax_Preview">O(n\sqrt{n})</span><script type="math/tex">O(n\sqrt{n})</script></span> 。</p>
<p>综上所述，莫队算法的时间复杂度为 <span><span class="MathJax_Preview">O(n\sqrt{n})</span><script type="math/tex">O(n\sqrt{n})</script></span> ；</p>
<p>但是对于 <span><span class="MathJax_Preview">m</span><script type="math/tex">m</script></span> 的其他取值，如 <span><span class="MathJax_Preview">m&lt;n</span><script type="math/tex">m<n</script></span> ，分块方式需要改变才能变的更优。</p>
<p>怎么分块呢？</p>
<p>我们设块长度为 <span><span class="MathJax_Preview">S</span><script type="math/tex">S</script></span> ，那么对于任意多个在同一块内的询问，挪动的距离就是 <span><span class="MathJax_Preview">n</span><script type="math/tex">n</script></span> ，一共 <span><span class="MathJax_Preview">\displaystyle \frac{n}{S}</span><script type="math/tex">\displaystyle \frac{n}{S}</script></span> 个块，移动的总次数就是 <span><span class="MathJax_Preview">\displaystyle \frac{n^2}{S}</span><script type="math/tex">\displaystyle \frac{n^2}{S}</script></span> ，移动可能跨越块，所以还要加上一个 <span><span class="MathJax_Preview">mS</span><script type="math/tex">mS</script></span> 的复杂度，总复杂度为 <span><span class="MathJax_Preview">\displaystyle O\left(\frac{n^2}{S}+mS\right)</span><script type="math/tex">\displaystyle O\left(\frac{n^2}{S}+mS\right)</script></span> ，我们要让这个值尽量小，那么就要将这两个项尽量相等，发现 <span><span class="MathJax_Preview">S</span><script type="math/tex">S</script></span> 取 <span><span class="MathJax_Preview">\displaystyle \frac{n}{\sqrt{m}}</span><script type="math/tex">\displaystyle \frac{n}{\sqrt{m}}</script></span> 是最优的，此时复杂度为 <span><span class="MathJax_Preview">\displaystyle O\left(\frac{n^2}{\displaystyle \frac{n}{\sqrt{m}}}+m\left(\frac{n}{\sqrt{m}}\right)\right)=O(n\sqrt{m})</span><script type="math/tex">\displaystyle O\left(\frac{n^2}{\displaystyle \frac{n}{\sqrt{m}}}+m\left(\frac{n}{\sqrt{m}}\right)\right)=O(n\sqrt{m})</script></span> 。</p>
<h3 id="_8">例题 &amp; 代码<a class="headerlink" href="#_8" title="Permanent link">&para;</a></h3>
<p><a href="https://www.lydsy.com/JudgeOnline/problem.php?id=2038">小 Z 的袜子</a></p>
<p>思路：莫队算法模板题。</p>
<p>对于区间 <span><span class="MathJax_Preview">[l,r]</span><script type="math/tex">[l,r]</script></span> ，以 <span><span class="MathJax_Preview">l</span><script type="math/tex">l</script></span> 所在块的编号为第一关键字， <span><span class="MathJax_Preview">r</span><script type="math/tex">r</script></span> 为第二关键字从小到大排序。
然后从序列的第一个询问开始计算答案，第一个询问通过直接暴力算出，复杂度为 <span><span class="MathJax_Preview">O(n)</span><script type="math/tex">O(n)</script></span> ，后面的询问在前一个询问的基础上得到答案。</p>
<p>具体做法：</p>
<p>对于区间 <span><span class="MathJax_Preview">[i,i]</span><script type="math/tex">[i,i]</script></span> ，由于区间只有一个元素，我们很容易就能知道答案。
然后一步一步从当前区间（已知答案）向下一个区间靠近。</p>
<p>我们设 <span><span class="MathJax_Preview">col[i]</span><script type="math/tex">col[i]</script></span> 表示当前颜色 i 出现了多少次， <span><span class="MathJax_Preview">ans</span><script type="math/tex">ans</script></span> 当前共有多少种可行的配对方案（有多少种可以选到一双颜色相同的袜子），表示然后每次移动的时候更新答案——设当前颜色为 <span><span class="MathJax_Preview">k</span><script type="math/tex">k</script></span> ，如果是增长区间就是 <span><span class="MathJax_Preview">ans</span><script type="math/tex">ans</script></span> 加上 <span><span class="MathJax_Preview">C_{col[k]+1}^2-C_{col[k]}^2</span><script type="math/tex">C_{col[k]+1}^2-C_{col[k]}^2</script></span> ，如果是缩短就是 <span><span class="MathJax_Preview">ans</span><script type="math/tex">ans</script></span> 减去 <span><span class="MathJax_Preview">C_{col[k]}^2-C_{col[k]-1}^2</span><script type="math/tex">C_{col[k]}^2-C_{col[k]-1}^2</script></span> 。这应该很好理解。</p>
<p>而这个询问的答案就是 <span><span class="MathJax_Preview">\displaystyle \frac{ans}{C_{r-l+1}^2}</span><script type="math/tex">\displaystyle \frac{ans}{C_{r-l+1}^2}</script></span> 。</p>
<p>这里有个优化： <span><span class="MathJax_Preview">\displaystyle C_a^2=\frac{a (a-1)}{2}</span><script type="math/tex">\displaystyle C_a^2=\frac{a (a-1)}{2}</script></span> 。</p>
<p>所以 <span><span class="MathJax_Preview">\displaystyle C_{a+1}^2-C_a^2=\frac{(a+1) a}{2}-\frac{a (a-1)}{2}=\frac{a}{2}\cdot (a+1-a+1)=\frac{a}{2}\cdot 2=a</span><script type="math/tex">\displaystyle C_{a+1}^2-C_a^2=\frac{(a+1) a}{2}-\frac{a (a-1)}{2}=\frac{a}{2}\cdot (a+1-a+1)=\frac{a}{2}\cdot 2=a</script></span> 。</p>
<p>所以 <span><span class="MathJax_Preview">C_{col[k]+1}^2-C_{col[k]}^2=col[k]</span><script type="math/tex">C_{col[k]+1}^2-C_{col[k]}^2=col[k]</script></span> 。</p>
<p>这样我们少算了很多东西呢！
至少我的代码在 BZOJ 上测快了一倍。</p>
<p>还有，算 <span><span class="MathJax_Preview">C_a^2</span><script type="math/tex">C_a^2</script></span> 可以用位运算， <code>a/2</code> 可以写成 <code>a&gt;&gt;1</code> 。</p>
<p>算法总复杂度： <span><span class="MathJax_Preview">O(n\sqrt{n} )</span><script type="math/tex">O(n\sqrt{n} )</script></span> </p>
<p>下面的代码中 <code>mot</code> 表示答案的分母 (mother)， <code>sub</code> 表示分子， <code>sqn</code> 表示块的大小： <span><span class="MathJax_Preview">\sqrt{n}</span><script type="math/tex">\sqrt{n}</script></span> ， <code>arr</code> 是输入的数组， <code>node</code> 是存储询问的结构体， <code>tab</code> 是询问序列（排序后的）， <code>col</code> 同上所述。<strong >注意：下面代码中的移动区间的 4 个 for 循环的位置很关键，不能改变它们之间的位置关系，不然会 WA（因为有那个 <code>++l</code> 和 <code>--r</code> ）。</strong>代码：</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;bits/stdc++.h&gt;</span><span class="cp"></span>
<span class="cp">#define bi(a) ((a - 1) / sqn + 1)</span>
<span class="k">using</span> <span class="k">namespace</span> <span class="n">std</span><span class="p">;</span>
<span class="k">typedef</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">LL</span><span class="p">;</span>
<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">tp</span><span class="o">&gt;</span>
<span class="kt">void</span> <span class="n">read</span><span class="p">(</span><span class="n">tp</span><span class="o">&amp;</span> <span class="n">dig</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">char</span> <span class="n">c</span> <span class="o">=</span> <span class="n">getchar</span><span class="p">();</span>
  <span class="n">dig</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">isdigit</span><span class="p">(</span><span class="n">c</span><span class="p">))</span> <span class="n">c</span> <span class="o">=</span> <span class="n">getchar</span><span class="p">();</span>
  <span class="k">while</span> <span class="p">(</span><span class="n">isdigit</span><span class="p">(</span><span class="n">c</span><span class="p">))</span> <span class="n">dig</span> <span class="o">=</span> <span class="n">dig</span> <span class="o">*</span> <span class="mi">10</span> <span class="o">+</span> <span class="n">c</span> <span class="o">-</span> <span class="sc">&#39;0&#39;</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="n">getchar</span><span class="p">();</span>
<span class="p">}</span>
<span class="k">struct</span> <span class="n">node</span> <span class="p">{</span>
  <span class="n">LL</span> <span class="n">l</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
<span class="p">};</span>
<span class="n">LL</span> <span class="n">n</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">sqn</span><span class="p">,</span> <span class="n">arr</span><span class="p">[</span><span class="mi">50005</span><span class="p">],</span> <span class="n">l</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">ans</span><span class="p">,</span> <span class="n">col</span><span class="p">[</span><span class="mi">50005</span><span class="p">],</span> <span class="n">sub</span><span class="p">[</span><span class="mi">50005</span><span class="p">],</span> <span class="n">mot</span><span class="p">[</span><span class="mi">50005</span><span class="p">];</span>
<span class="n">vector</span><span class="o">&lt;</span><span class="n">node</span><span class="o">&gt;</span> <span class="n">tab</span><span class="p">;</span>
<span class="kt">bool</span> <span class="nf">cmp</span><span class="p">(</span><span class="n">node</span> <span class="n">a</span><span class="p">,</span> <span class="n">node</span> <span class="n">b</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">bi</span><span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">l</span><span class="p">)</span> <span class="o">==</span> <span class="n">bi</span><span class="p">(</span><span class="n">b</span><span class="p">.</span><span class="n">l</span><span class="p">))</span> <span class="k">return</span> <span class="n">a</span><span class="p">.</span><span class="n">r</span> <span class="o">&lt;</span> <span class="n">b</span><span class="p">.</span><span class="n">r</span><span class="p">;</span>
  <span class="k">return</span> <span class="n">a</span><span class="p">.</span><span class="n">l</span> <span class="o">&lt;</span> <span class="n">b</span><span class="p">.</span><span class="n">l</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">LL</span> <span class="nf">gcd</span><span class="p">(</span><span class="n">LL</span> <span class="n">a</span><span class="p">,</span> <span class="n">LL</span> <span class="n">b</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="o">!</span><span class="n">b</span> <span class="o">?</span> <span class="nl">a</span> <span class="p">:</span> <span class="n">gcd</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">a</span> <span class="o">%</span> <span class="n">b</span><span class="p">);</span> <span class="p">}</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">read</span><span class="p">(</span><span class="n">n</span><span class="p">),</span> <span class="n">read</span><span class="p">(</span><span class="n">m</span><span class="p">),</span> <span class="n">sqn</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">n</span><span class="p">);</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">LL</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">n</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="n">read</span><span class="p">(</span><span class="n">arr</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">LL</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">m</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
    <span class="n">read</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="n">read</span><span class="p">(</span><span class="n">b</span><span class="p">),</span> <span class="n">tab</span><span class="p">.</span><span class="n">push_back</span><span class="p">((</span><span class="n">node</span><span class="p">){</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">i</span><span class="p">});</span>
  <span class="n">sort</span><span class="p">(</span><span class="n">tab</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">tab</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span> <span class="n">cmp</span><span class="p">),</span> <span class="n">l</span> <span class="o">=</span> <span class="n">r</span> <span class="o">=</span> <span class="n">tab</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">l</span><span class="p">,</span> <span class="n">col</span><span class="p">[</span><span class="n">arr</span><span class="p">[</span><span class="n">l</span><span class="p">]]</span><span class="o">++</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">LL</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">gcdnum</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">tab</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(;</span> <span class="n">l</span> <span class="o">&lt;</span> <span class="n">tab</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">l</span><span class="p">;</span> <span class="n">l</span><span class="o">++</span><span class="p">)</span> <span class="n">col</span><span class="p">[</span><span class="n">arr</span><span class="p">[</span><span class="n">l</span><span class="p">]]</span><span class="o">--</span><span class="p">,</span> <span class="n">ans</span> <span class="o">-=</span> <span class="n">col</span><span class="p">[</span><span class="n">arr</span><span class="p">[</span><span class="n">l</span><span class="p">]];</span>
    <span class="k">for</span> <span class="p">(</span><span class="o">--</span><span class="n">l</span><span class="p">;</span> <span class="n">l</span> <span class="o">&gt;=</span> <span class="n">tab</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">l</span><span class="p">;</span> <span class="n">l</span><span class="o">--</span><span class="p">)</span> <span class="n">ans</span> <span class="o">+=</span> <span class="n">col</span><span class="p">[</span><span class="n">arr</span><span class="p">[</span><span class="n">l</span><span class="p">]],</span> <span class="n">col</span><span class="p">[</span><span class="n">arr</span><span class="p">[</span><span class="n">l</span><span class="p">]]</span><span class="o">++</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(;</span> <span class="n">r</span> <span class="o">&gt;</span> <span class="n">tab</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">r</span><span class="p">;</span> <span class="n">r</span><span class="o">--</span><span class="p">)</span> <span class="n">col</span><span class="p">[</span><span class="n">arr</span><span class="p">[</span><span class="n">r</span><span class="p">]]</span><span class="o">--</span><span class="p">,</span> <span class="n">ans</span> <span class="o">-=</span> <span class="n">col</span><span class="p">[</span><span class="n">arr</span><span class="p">[</span><span class="n">r</span><span class="p">]];</span>
    <span class="k">for</span> <span class="p">(</span><span class="o">++</span><span class="n">r</span><span class="p">;</span> <span class="n">r</span> <span class="o">&lt;=</span> <span class="n">tab</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">r</span><span class="p">;</span> <span class="n">r</span><span class="o">++</span><span class="p">)</span> <span class="n">ans</span> <span class="o">+=</span> <span class="n">col</span><span class="p">[</span><span class="n">arr</span><span class="p">[</span><span class="n">r</span><span class="p">]],</span> <span class="n">col</span><span class="p">[</span><span class="n">arr</span><span class="p">[</span><span class="n">r</span><span class="p">]]</span><span class="o">++</span><span class="p">;</span>
    <span class="n">sub</span><span class="p">[</span><span class="n">tab</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ans</span><span class="p">,</span> <span class="n">l</span> <span class="o">=</span> <span class="n">tab</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">l</span><span class="p">,</span> <span class="n">r</span> <span class="o">=</span> <span class="n">tab</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">r</span><span class="p">;</span>
    <span class="n">mot</span><span class="p">[</span><span class="n">tab</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">r</span> <span class="o">-</span> <span class="n">l</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">r</span> <span class="o">-</span> <span class="n">l</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">LL</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">gcdn</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">m</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
    <span class="n">gcdn</span> <span class="o">=</span> <span class="n">gcd</span><span class="p">(</span><span class="n">sub</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">mot</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%lld/%lld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sub</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="n">gcdn</span><span class="p">,</span> <span class="n">mot</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="n">gcdn</span><span class="p">);</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>

<h2 id="_9">普通莫队的优化<a class="headerlink" href="#_9" title="Permanent link">&para;</a></h2>
<p>我们看一下下面这组数据</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>// 设块的大小为 2 (假设)
1 1
2 100
3 1
4 100
</pre></div>
</td></tr></table>

<p>手动模拟一下可以发现，r 指针的移动次数大概为 300 次，我们处理完第一个块之后， <span><span class="MathJax_Preview">l = 2, r = 100</span><script type="math/tex">l = 2, r = 100</script></span> ，此时只需要移动两次 l 指针就可以得到第四个询问的答案，但是我们却将 r 指针移动到 1 来获取第三个询问的答案，再移动到 100 获取第四个询问的答案，这样多了九十几次的指针移动。我们怎么优化这个地方呢？这里我们就要用到奇偶化排序</p>
<p>什么是奇偶化排序？奇偶化排序即对于属于奇数块的询问，r 按从小到大排序，对于属于偶数块的排序，r 从大到小排序，这样我们的 r 指针在处理完这个奇数块的问题后，将在返回的途中处理偶数块的问题，再向 n 移动处理下一个奇数块的问题，优化了 r 指针的移动次数，一般情况下，这种优化能让程序快 30% 左右</p>
<p>排序代码：</p>
<p>压行</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="c1">// 这里有个小细节等下会讲</span>
<span class="kt">int</span> <span class="n">unit</span><span class="p">;</span>  <span class="c1">// 块的大小</span>
<span class="k">struct</span> <span class="n">node</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">l</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">id</span><span class="p">;</span>
  <span class="kt">bool</span> <span class="k">operator</span><span class="o">&lt;</span><span class="p">(</span><span class="k">const</span> <span class="n">node</span> <span class="o">&amp;</span><span class="n">x</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">l</span> <span class="o">/</span> <span class="n">unit</span> <span class="o">==</span> <span class="n">x</span><span class="p">.</span><span class="n">l</span> <span class="o">/</span> <span class="n">unit</span>
               <span class="o">?</span> <span class="p">(</span><span class="n">r</span> <span class="o">==</span> <span class="n">x</span><span class="p">.</span><span class="n">r</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="p">((</span><span class="n">l</span> <span class="o">/</span> <span class="n">unit</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">^</span> <span class="p">(</span><span class="n">r</span> <span class="o">&lt;</span> <span class="n">x</span><span class="p">.</span><span class="n">r</span><span class="p">))</span>
               <span class="o">:</span> <span class="n">l</span> <span class="o">&lt;</span> <span class="n">x</span><span class="p">.</span><span class="n">l</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">};</span>
</pre></div>
</td></tr></table>

<p>不压行</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="k">struct</span> <span class="n">node</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">l</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">id</span><span class="p">;</span>
  <span class="kt">bool</span> <span class="k">operator</span><span class="o">&lt;</span><span class="p">(</span><span class="k">const</span> <span class="n">node</span> <span class="o">&amp;</span><span class="n">x</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">l</span> <span class="o">/</span> <span class="n">unit</span> <span class="o">!=</span> <span class="n">x</span><span class="p">.</span><span class="n">l</span> <span class="o">/</span> <span class="n">unit</span><span class="p">)</span> <span class="k">return</span> <span class="n">l</span> <span class="o">&lt;</span> <span class="n">x</span><span class="p">.</span><span class="n">l</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">l</span> <span class="o">/</span> <span class="n">unit</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">r</span> <span class="o">&lt;</span>
             <span class="n">x</span><span class="p">.</span><span class="n">r</span><span class="p">;</span>  <span class="c1">// 注意这里和下面一行不能写小于（大于）等于，否则会出错（详见下面的小细节）</span>
    <span class="k">return</span> <span class="n">r</span> <span class="o">&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">r</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">};</span>
</pre></div>
</td></tr></table>

<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>小细节：如果使用 sort 比较两个函数，不能出现 <span><span class="MathJax_Preview">a &lt; b == true</span><script type="math/tex">a < b == true</script></span> 且 <span><span class="MathJax_Preview">b &lt; a == true</span><script type="math/tex">b < a == true</script></span> 的情况，否则会运行错误</p>
</div>
<p>对于压行版，如果没有 <span><span class="MathJax_Preview">r == x.r</span><script type="math/tex">r == x.r</script></span> 的特判，当 l 属于同一奇数块且 r 相等时，会出现上面小细节中的问题（自己手动模拟一下），对于压行版，如果写成小于（大于）等于，则也会出现同样的问题</p>
<h2 id="_10">带修改<a class="headerlink" href="#_10" title="Permanent link">&para;</a></h2>
<p>请确保您已经会普通莫队算法了。
如果您还不会，请先阅读上面的“普通莫队算法”</p>
<h3 id="_11">特点<a class="headerlink" href="#_11" title="Permanent link">&para;</a></h3>
<p>普通莫队是不能带修改的</p>
<p>我们可以强行让它可以修改，就像 DP 一样，可以强行加上一维 <strong>时间维</strong> , 表示这次操作的时间。</p>
<p>时间维表示经历的修改次数。</p>
<p>即把询问 <span><span class="MathJax_Preview">[l,r]</span><script type="math/tex">[l,r]</script></span> 变成 <span><span class="MathJax_Preview">[l,r,time]</span><script type="math/tex">[l,r,time]</script></span> </p>
<p>那么我们的坐标也可以在时间维上移动，即 <span><span class="MathJax_Preview">[l,r,time]</span><script type="math/tex">[l,r,time]</script></span> 多了一维可以移动的方向，可以变成：</p>
<ul>
<li><span><span class="MathJax_Preview">[l-1,r,time]</span><script type="math/tex">[l-1,r,time]</script></span> </li>
<li><span><span class="MathJax_Preview">[l+1,r,time]</span><script type="math/tex">[l+1,r,time]</script></span> </li>
<li><span><span class="MathJax_Preview">[l,r-1,time]</span><script type="math/tex">[l,r-1,time]</script></span> </li>
<li><span><span class="MathJax_Preview">[l,r+1,time]</span><script type="math/tex">[l,r+1,time]</script></span> </li>
<li><span><span class="MathJax_Preview">[l,r,time-1]</span><script type="math/tex">[l,r,time-1]</script></span> </li>
<li><span><span class="MathJax_Preview">[l,r,time+1]</span><script type="math/tex">[l,r,time+1]</script></span> </li>
</ul>
<p>这样的转移也是 <span><span class="MathJax_Preview">O(1)</span><script type="math/tex">O(1)</script></span> 的，但是我们排序又多了一个关键字，再搞搞就行了</p>
<p>可以用和普通莫队类似的方法排序转移，做到 <span><span class="MathJax_Preview">O(n^{\frac{5}{3}})</span><script type="math/tex">O(n^{\frac{5}{3}})</script></span> </p>
<p>这一次我们排序的方式是以 <span><span class="MathJax_Preview">n^{\frac{2}{3}}</span><script type="math/tex">n^{\frac{2}{3}}</script></span> 为一块，分成了 <span><span class="MathJax_Preview">n^{\frac{1}{3}}</span><script type="math/tex">n^{\frac{1}{3}}</script></span> 块，第一关键字是左端点所在块，第二关键字是右端点所在块，第三关键字是时间。</p>
<p>还是来证明一下时间复杂度（默认块大小为 <span><span class="MathJax_Preview">\sqrt{n}</span><script type="math/tex">\sqrt{n}</script></span> ）：</p>
<ul>
<li>左右端点所在块不变，时间在排序后单调向右移，这样的复杂度是 <span><span class="MathJax_Preview">O(n)</span><script type="math/tex">O(n)</script></span> </li>
<li>若左右端点所在块改变，时间一次最多会移动 n 个格子，时间复杂度 <span><span class="MathJax_Preview">O(n)</span><script type="math/tex">O(n)</script></span> </li>
<li>左端点所在块一共有 <span><span class="MathJax_Preview">n^{\frac{1}{3}}</span><script type="math/tex">n^{\frac{1}{3}}</script></span> 中，右端点也是 <span><span class="MathJax_Preview">n^{\frac{1}{3}}</span><script type="math/tex">n^{\frac{1}{3}}</script></span> 种，一共 <span><span class="MathJax_Preview">{n^{\frac{1}{3}}}\times{n^{\frac{1}{3}}}=n^{\frac{2}{3}}</span><script type="math/tex">{n^{\frac{1}{3}}}\times{n^{\frac{1}{3}}}=n^{\frac{2}{3}}</script></span> 种，每种乘上移动的复杂度 <span><span class="MathJax_Preview">O(n)</span><script type="math/tex">O(n)</script></span> ，总复杂度 <span><span class="MathJax_Preview">O(n^{\frac{5}{3}})</span><script type="math/tex">O(n^{\frac{5}{3}})</script></span> </li>
</ul>
<h3 id="_12">例题<a class="headerlink" href="#_12" title="Permanent link">&para;</a></h3>
<p><a href="https://www.lydsy.com/JudgeOnline/problem.php?id=2120">数颜色 BZOJ - 2120</a></p>
<p>题目大意：给你一个序列，M 个操作，有两种操作：</p>
<ol>
<li>修改序列上某一位的数字</li>
<li>询问区间 <span><span class="MathJax_Preview">[l,r]</span><script type="math/tex">[l,r]</script></span> 中数字的种类数（多个相同的数字只算一个）</li>
</ol>
<p>我们不难发现，如果不带操作 1（修改）的话，我们就能轻松用普通莫队解决。</p>
<p>但是题目还带单点修改，所以用 <strong>带修改的莫队</strong> 。</p>
<p>先考虑普通莫队的做法：</p>
<ul>
<li>每次扩大区间时，每加入一个数字，则统计它已经出现的次数，如果加入前这种数字出现次数为 <span><span class="MathJax_Preview">0</span><script type="math/tex">0</script></span> ，则说明这是一种新的数字，答案 <span><span class="MathJax_Preview">+1</span><script type="math/tex">+1</script></span> 。然后这种数字的出现次数 <span><span class="MathJax_Preview">+1</span><script type="math/tex">+1</script></span> 。</li>
<li>每次减小区间时，每删除一个数字，则统计它删除后的出现次数，如果删除后这种数字出现次数为 <span><span class="MathJax_Preview">0</span><script type="math/tex">0</script></span> ，则说明这种数字已经从当前的区间内删光了，也就是当前区间减少了一种颜色，答案 <span><span class="MathJax_Preview">-1</span><script type="math/tex">-1</script></span> 。然后这种数字的出现次数 <span><span class="MathJax_Preview">-1</span><script type="math/tex">-1</script></span> 。</li>
</ul>
<p>现在再来考虑修改：</p>
<ul>
<li>单点修改，把某一位的数字修改掉。假如我们是从一个经历修改次数为 <span><span class="MathJax_Preview">i</span><script type="math/tex">i</script></span> 的询问转移到一个经历修改次数为 <span><span class="MathJax_Preview">j</span><script type="math/tex">j</script></span> 的询问上，且 <span><span class="MathJax_Preview">i&lt;j</span><script type="math/tex">i<j</script></span> 的话，我们就需要把第 <span><span class="MathJax_Preview">i+1</span><script type="math/tex">i+1</script></span> 个到第 <span><span class="MathJax_Preview">j</span><script type="math/tex">j</script></span> 个修改强行加上。</li>
<li>假如 <span><span class="MathJax_Preview">j&lt;i</span><script type="math/tex">j<i</script></span> 的话，则需要把第 <span><span class="MathJax_Preview">i</span><script type="math/tex">i</script></span> 个到第 <span><span class="MathJax_Preview">j+1</span><script type="math/tex">j+1</script></span> 个修改强行还原。</li>
</ul>
<p>怎么强行加上一个修改呢？假设一个修改是修改第 <span><span class="MathJax_Preview">pos</span><script type="math/tex">pos</script></span> 个位置上的颜色，原本 <span><span class="MathJax_Preview">pos</span><script type="math/tex">pos</script></span> 上的颜色为 <span><span class="MathJax_Preview">a</span><script type="math/tex">a</script></span> ，修改后颜色为 <span><span class="MathJax_Preview">b</span><script type="math/tex">b</script></span> ，还假设当前莫队的区间扩展到了 <span><span class="MathJax_Preview">[l,r]</span><script type="math/tex">[l,r]</script></span> 。</p>
<ul>
<li>加上这个修改：我们首先判断 <span><span class="MathJax_Preview">pos</span><script type="math/tex">pos</script></span> 是否在区间 <span><span class="MathJax_Preview">[l,r]</span><script type="math/tex">[l,r]</script></span> 内。如果是的话，我们等于是从区间中删掉颜色 <span><span class="MathJax_Preview">a</span><script type="math/tex">a</script></span> ，加上颜色 <span><span class="MathJax_Preview">b</span><script type="math/tex">b</script></span> ，并且当前颜色序列的第 <span><span class="MathJax_Preview">pos</span><script type="math/tex">pos</script></span> 项的颜色改成 <span><span class="MathJax_Preview">b</span><script type="math/tex">b</script></span> 。如果不在区间 <span><span class="MathJax_Preview">[l,r]</span><script type="math/tex">[l,r]</script></span> 内的话，我们就直接修改当前颜色序列的第 <span><span class="MathJax_Preview">pos</span><script type="math/tex">pos</script></span> 项为 <span><span class="MathJax_Preview">b</span><script type="math/tex">b</script></span> 。</li>
<li>还原这个修改：等于加上一个修改第 <span><span class="MathJax_Preview">pos</span><script type="math/tex">pos</script></span> 项、把颜色 <span><span class="MathJax_Preview">b</span><script type="math/tex">b</script></span> 改成颜色 <span><span class="MathJax_Preview">a</span><script type="math/tex">a</script></span> 的修改。</li>
</ul>
<p>因此这道题就这样用带修改莫队轻松解决啦！</p>
<p>代码：</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;bits/stdc++.h&gt;</span><span class="cp"></span>
<span class="cp">#define SZ (10005)</span>
<span class="k">using</span> <span class="k">namespace</span> <span class="n">std</span><span class="p">;</span>
<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">_Tp</span><span class="o">&gt;</span>
<span class="kr">inline</span> <span class="kt">void</span> <span class="n">IN</span><span class="p">(</span><span class="n">_Tp</span><span class="o">&amp;</span> <span class="n">dig</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">char</span> <span class="n">c</span><span class="p">;</span>
  <span class="n">dig</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">while</span> <span class="p">(</span><span class="n">c</span> <span class="o">=</span> <span class="n">getchar</span><span class="p">(),</span> <span class="o">!</span><span class="n">isdigit</span><span class="p">(</span><span class="n">c</span><span class="p">))</span>
    <span class="p">;</span>
  <span class="k">while</span> <span class="p">(</span><span class="n">isdigit</span><span class="p">(</span><span class="n">c</span><span class="p">))</span> <span class="n">dig</span> <span class="o">=</span> <span class="n">dig</span> <span class="o">*</span> <span class="mi">10</span> <span class="o">+</span> <span class="n">c</span> <span class="o">-</span> <span class="sc">&#39;0&#39;</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="n">getchar</span><span class="p">();</span>
<span class="p">}</span>
<span class="kt">int</span> <span class="n">n</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">sqn</span><span class="p">,</span> <span class="n">c</span><span class="p">[</span><span class="n">SZ</span><span class="p">],</span> <span class="n">ct</span><span class="p">[</span><span class="n">SZ</span><span class="p">],</span> <span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">,</span> <span class="n">mem</span><span class="p">[</span><span class="n">SZ</span><span class="p">][</span><span class="mi">3</span><span class="p">],</span> <span class="n">ans</span><span class="p">,</span> <span class="n">tot</span><span class="p">[</span><span class="mi">1000005</span><span class="p">],</span> <span class="n">nal</span><span class="p">[</span><span class="n">SZ</span><span class="p">];</span>
<span class="k">struct</span> <span class="n">query</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">l</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span><span class="p">;</span>
  <span class="kt">bool</span> <span class="k">operator</span><span class="o">&lt;</span><span class="p">(</span><span class="k">const</span> <span class="n">query</span> <span class="n">another</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">l</span> <span class="o">/</span> <span class="n">sqn</span> <span class="o">==</span> <span class="n">another</span><span class="p">.</span><span class="n">l</span> <span class="o">/</span> <span class="n">sqn</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">/</span> <span class="n">sqn</span> <span class="o">==</span> <span class="n">another</span><span class="p">.</span><span class="n">r</span> <span class="o">/</span> <span class="n">sqn</span><span class="p">)</span> <span class="k">return</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">another</span><span class="p">.</span><span class="n">i</span><span class="p">;</span>
      <span class="k">return</span> <span class="n">r</span> <span class="o">&lt;</span> <span class="n">another</span><span class="p">.</span><span class="n">r</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">l</span> <span class="o">&lt;</span> <span class="n">another</span><span class="p">.</span><span class="n">l</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span> <span class="n">Q</span><span class="p">[</span><span class="n">SZ</span><span class="p">];</span>
<span class="kt">void</span> <span class="nf">add</span><span class="p">(</span><span class="kt">int</span> <span class="n">a</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tot</span><span class="p">[</span><span class="n">a</span><span class="p">])</span> <span class="n">ans</span><span class="o">++</span><span class="p">;</span>
  <span class="n">tot</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>
<span class="kt">void</span> <span class="nf">del</span><span class="p">(</span><span class="kt">int</span> <span class="n">a</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">tot</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">--</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tot</span><span class="p">[</span><span class="n">a</span><span class="p">])</span> <span class="n">ans</span><span class="o">--</span><span class="p">;</span>
<span class="p">}</span>
<span class="kt">char</span> <span class="n">opt</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">IN</span><span class="p">(</span><span class="n">n</span><span class="p">),</span> <span class="n">IN</span><span class="p">(</span><span class="n">m</span><span class="p">),</span> <span class="n">sqn</span> <span class="o">=</span> <span class="n">pow</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="mi">2</span> <span class="o">/</span> <span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="mi">3</span><span class="p">);</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">n</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="n">IN</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="n">ct</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">m</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">scanf</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">opt</span><span class="p">),</span> <span class="n">IN</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="n">IN</span><span class="p">(</span><span class="n">b</span><span class="p">),</span> <span class="n">opt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;Q&#39;</span><span class="p">)</span>
      <span class="n">Q</span><span class="p">[</span><span class="n">c1</span><span class="p">].</span><span class="n">l</span> <span class="o">=</span> <span class="n">a</span><span class="p">,</span> <span class="n">Q</span><span class="p">[</span><span class="n">c1</span><span class="p">].</span><span class="n">r</span> <span class="o">=</span> <span class="n">b</span><span class="p">,</span> <span class="n">Q</span><span class="p">[</span><span class="n">c1</span><span class="p">].</span><span class="n">i</span> <span class="o">=</span> <span class="n">c1</span><span class="p">,</span> <span class="n">Q</span><span class="p">[</span><span class="n">c1</span><span class="p">].</span><span class="n">c</span> <span class="o">=</span> <span class="n">c2</span><span class="p">,</span> <span class="n">c1</span><span class="o">++</span><span class="p">;</span>
    <span class="k">else</span>
      <span class="n">mem</span><span class="p">[</span><span class="n">c2</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span><span class="p">,</span> <span class="n">mem</span><span class="p">[</span><span class="n">c2</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">ct</span><span class="p">[</span><span class="n">a</span><span class="p">],</span> <span class="n">mem</span><span class="p">[</span><span class="n">c2</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">ct</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">=</span> <span class="n">b</span><span class="p">,</span> <span class="n">c2</span><span class="o">++</span><span class="p">;</span>
  <span class="n">sort</span><span class="p">(</span><span class="n">Q</span><span class="p">,</span> <span class="n">Q</span> <span class="o">+</span> <span class="n">c1</span><span class="p">),</span> <span class="n">add</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
  <span class="kt">int</span> <span class="n">l</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">r</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">lst</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">c1</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(;</span> <span class="n">lst</span> <span class="o">&lt;</span> <span class="n">Q</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">c</span><span class="p">;</span> <span class="n">lst</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">l</span> <span class="o">&lt;=</span> <span class="n">mem</span><span class="p">[</span><span class="n">lst</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="n">mem</span><span class="p">[</span><span class="n">lst</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">r</span><span class="p">)</span>
        <span class="n">del</span><span class="p">(</span><span class="n">mem</span><span class="p">[</span><span class="n">lst</span><span class="p">][</span><span class="mi">1</span><span class="p">]),</span> <span class="n">add</span><span class="p">(</span><span class="n">mem</span><span class="p">[</span><span class="n">lst</span><span class="p">][</span><span class="mi">2</span><span class="p">]);</span>
      <span class="n">c</span><span class="p">[</span><span class="n">mem</span><span class="p">[</span><span class="n">lst</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">mem</span><span class="p">[</span><span class="n">lst</span><span class="p">][</span><span class="mi">2</span><span class="p">];</span>
    <span class="p">}</span>
    <span class="k">for</span> <span class="p">(;</span> <span class="n">lst</span> <span class="o">&gt;</span> <span class="n">Q</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">c</span><span class="p">;</span> <span class="n">lst</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">l</span> <span class="o">&lt;=</span> <span class="n">mem</span><span class="p">[</span><span class="n">lst</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="n">mem</span><span class="p">[</span><span class="n">lst</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">r</span><span class="p">)</span>
        <span class="n">del</span><span class="p">(</span><span class="n">mem</span><span class="p">[</span><span class="n">lst</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">]),</span> <span class="n">add</span><span class="p">(</span><span class="n">mem</span><span class="p">[</span><span class="n">lst</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]);</span>
      <span class="n">c</span><span class="p">[</span><span class="n">mem</span><span class="p">[</span><span class="n">lst</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">mem</span><span class="p">[</span><span class="n">lst</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">];</span>
    <span class="p">}</span>
    <span class="k">for</span> <span class="p">(</span><span class="o">++</span><span class="n">r</span><span class="p">;</span> <span class="n">r</span> <span class="o">&lt;=</span> <span class="n">Q</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">r</span><span class="p">;</span> <span class="n">r</span><span class="o">++</span><span class="p">)</span> <span class="n">add</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="n">r</span><span class="p">]);</span>
    <span class="k">for</span> <span class="p">(</span><span class="o">--</span><span class="n">r</span><span class="p">;</span> <span class="n">r</span> <span class="o">&gt;</span> <span class="n">Q</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">r</span><span class="p">;</span> <span class="n">r</span><span class="o">--</span><span class="p">)</span> <span class="n">del</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="n">r</span><span class="p">]);</span>
    <span class="k">for</span> <span class="p">(</span><span class="o">--</span><span class="n">l</span><span class="p">;</span> <span class="n">l</span> <span class="o">&gt;=</span> <span class="n">Q</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">l</span><span class="p">;</span> <span class="n">l</span><span class="o">--</span><span class="p">)</span> <span class="n">add</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="n">l</span><span class="p">]);</span>
    <span class="k">for</span> <span class="p">(</span><span class="o">++</span><span class="n">l</span><span class="p">;</span> <span class="n">l</span> <span class="o">&lt;</span> <span class="n">Q</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">l</span><span class="p">;</span> <span class="n">l</span><span class="o">++</span><span class="p">)</span> <span class="n">del</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="n">l</span><span class="p">]);</span>
    <span class="n">nal</span><span class="p">[</span><span class="n">Q</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ans</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">c1</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">nal</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>

<h2 id="_13">树上莫队<a class="headerlink" href="#_13" title="Permanent link">&para;</a></h2>
<p>一般的莫队只能处理线性问题，我们要把树强行压成序列</p>
<p>我们可以将树的括号序跑下来，把括号序分块，在括号序上跑莫队</p>
<p>具体怎么做呢？</p>
<p>dfs 一棵树，然后如果 dfs 到 x 点，就 push_back(x),dfs 完 x 点，就直接 push_back(-x)，然后我们在挪动指针的时候</p>
<ul>
<li>新加入的值是 x  ---&gt; add(x)</li>
<li>新加入的值是 - x ---&gt; del(x)</li>
<li>新删除的值是 x  ---&gt; del(x)</li>
<li>新删除的值是 - x ---&gt; add(x)</li>
</ul>
<p>这样的话，我们就把一棵树处理成了序列。</p>
<p>例题是<a href="http://uoj.ac/problem/58">[WC2013]糖果公园</a>, 这题是带修改树上莫队</p>
<p>题意是给你一棵树，每个点有颜色，每次询问</p>
<p><span><span class="MathJax_Preview">\sum_{c}val_c\sum_{i=1}^{cnt_c}w_i</span><script type="math/tex">\sum_{c}val_c\sum_{i=1}^{cnt_c}w_i</script></span> </p>
<p><span><span class="MathJax_Preview">val</span><script type="math/tex">val</script></span> 表示该颜色的价值</p>
<p><span><span class="MathJax_Preview">cnt</span><script type="math/tex">cnt</script></span> 表示颜色出现的次数</p>
<p><span><span class="MathJax_Preview">w</span><script type="math/tex">w</script></span> 表示该颜色出现 <span><span class="MathJax_Preview">i</span><script type="math/tex">i</script></span> 次后的价值</p>
<p>先把树变成序列，然后每次添加/删除一个点，这个点的对答案的的贡献是可以在 <span><span class="MathJax_Preview">O(1)</span><script type="math/tex">O(1)</script></span> 时间内获得的，即 <span><span class="MathJax_Preview">val_c\times w_{cnt_{c+1}}</span><script type="math/tex">val_c\times w_{cnt_{c+1}}</script></span> </p>
<p>发现因为他会把起点的子树也扫了一遍，产生多余的贡献，怎么办呢？</p>
<p>因为扫的过程中起点的子树里的点肯定会被扫两次，但贡献为 0</p>
<p>所以可以开一个 <span><span class="MathJax_Preview">vis</span><script type="math/tex">vis</script></span> 数组，每次扫到点 x，就把 <span><span class="MathJax_Preview">vis_x</span><script type="math/tex">vis_x</script></span> 异或上 1</p>
<p>如果 <span><span class="MathJax_Preview">vis_x=0</span><script type="math/tex">vis_x=0</script></span> ，那这个点的贡献就可以不计</p>
<p>所以可以用树上莫队来求</p>
<p>修改的话，加上一维时间维即可，变成带修改树上莫队</p>
<p>然后因为所包含的区间内可能没有 LCA，对于没有的情况要将多余的贡献删除，然后就完事了</p>
<p>code：</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;algorithm&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;cmath&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;cstdio&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>

<span class="cp">#define DEBUG printf(&quot;line:%d func:%s\n&quot;, __LINE__, __FUNCTION__);</span>

<span class="k">using</span> <span class="k">namespace</span> <span class="n">std</span><span class="p">;</span>

<span class="k">const</span> <span class="kt">int</span> <span class="n">maxn</span> <span class="o">=</span> <span class="mi">200010</span><span class="p">;</span>

<span class="kt">int</span> <span class="n">f</span><span class="p">[</span><span class="n">maxn</span><span class="p">],</span> <span class="n">g</span><span class="p">[</span><span class="n">maxn</span><span class="p">],</span> <span class="n">id</span><span class="p">[</span><span class="n">maxn</span><span class="p">],</span> <span class="n">head</span><span class="p">[</span><span class="n">maxn</span><span class="p">],</span> <span class="n">cnt</span><span class="p">,</span> <span class="n">last</span><span class="p">[</span><span class="n">maxn</span><span class="p">],</span> <span class="n">dep</span><span class="p">[</span><span class="n">maxn</span><span class="p">],</span>
    <span class="n">fa</span><span class="p">[</span><span class="n">maxn</span><span class="p">][</span><span class="mi">22</span><span class="p">],</span> <span class="n">v</span><span class="p">[</span><span class="n">maxn</span><span class="p">],</span> <span class="n">w</span><span class="p">[</span><span class="n">maxn</span><span class="p">];</span>
<span class="kt">int</span> <span class="n">block</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">q</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">pos</span><span class="p">[</span><span class="n">maxn</span><span class="p">],</span> <span class="n">col</span><span class="p">[</span><span class="n">maxn</span><span class="p">],</span> <span class="n">app</span><span class="p">[</span><span class="n">maxn</span><span class="p">];</span>
<span class="kt">bool</span> <span class="n">vis</span><span class="p">[</span><span class="n">maxn</span><span class="p">];</span>
<span class="kt">long</span> <span class="kt">long</span> <span class="n">ans</span><span class="p">[</span><span class="n">maxn</span><span class="p">],</span> <span class="n">cur</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">edge</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">to</span><span class="p">,</span> <span class="n">nxt</span><span class="p">;</span>
<span class="p">}</span> <span class="n">e</span><span class="p">[</span><span class="n">maxn</span><span class="p">];</span>
<span class="kt">int</span> <span class="n">cnt1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cnt2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>  <span class="c1">// 时间戳</span>

<span class="k">struct</span> <span class="n">query</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">l</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">id</span><span class="p">;</span>
  <span class="kt">bool</span> <span class="k">operator</span><span class="o">&lt;</span><span class="p">(</span><span class="k">const</span> <span class="n">query</span> <span class="o">&amp;</span><span class="n">b</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">pos</span><span class="p">[</span><span class="n">l</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">pos</span><span class="p">[</span><span class="n">b</span><span class="p">.</span><span class="n">l</span><span class="p">])</span> <span class="o">||</span> <span class="p">(</span><span class="n">pos</span><span class="p">[</span><span class="n">l</span><span class="p">]</span> <span class="o">==</span> <span class="n">pos</span><span class="p">[</span><span class="n">b</span><span class="p">.</span><span class="n">l</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="n">pos</span><span class="p">[</span><span class="n">r</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">pos</span><span class="p">[</span><span class="n">b</span><span class="p">.</span><span class="n">r</span><span class="p">])</span> <span class="o">||</span>
           <span class="p">(</span><span class="n">pos</span><span class="p">[</span><span class="n">l</span><span class="p">]</span> <span class="o">==</span> <span class="n">pos</span><span class="p">[</span><span class="n">b</span><span class="p">.</span><span class="n">l</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="n">pos</span><span class="p">[</span><span class="n">r</span><span class="p">]</span> <span class="o">==</span> <span class="n">pos</span><span class="p">[</span><span class="n">b</span><span class="p">.</span><span class="n">r</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="n">t</span> <span class="o">&lt;</span> <span class="n">b</span><span class="p">.</span><span class="n">t</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span> <span class="n">a</span><span class="p">[</span><span class="n">maxn</span><span class="p">],</span> <span class="n">b</span><span class="p">[</span><span class="n">maxn</span><span class="p">];</span>

<span class="kr">inline</span> <span class="kt">void</span> <span class="nf">addedge</span><span class="p">(</span><span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="n">y</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">e</span><span class="p">[</span><span class="o">++</span><span class="n">cnt</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">edge</span><span class="p">){</span><span class="n">y</span><span class="p">,</span> <span class="n">head</span><span class="p">[</span><span class="n">x</span><span class="p">]};</span>
  <span class="n">head</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="n">cnt</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">dfs</span><span class="p">(</span><span class="kt">int</span> <span class="n">x</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">id</span><span class="p">[</span><span class="n">f</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="o">++</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">head</span><span class="p">[</span><span class="n">x</span><span class="p">];</span> <span class="n">i</span><span class="p">;</span> <span class="n">i</span> <span class="o">=</span> <span class="n">e</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">nxt</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">e</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">to</span> <span class="o">!=</span> <span class="n">fa</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
      <span class="n">fa</span><span class="p">[</span><span class="n">e</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">to</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">;</span>
      <span class="n">dep</span><span class="p">[</span><span class="n">e</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">to</span><span class="p">]</span> <span class="o">=</span> <span class="n">dep</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
      <span class="n">dfs</span><span class="p">(</span><span class="n">e</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">to</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="n">id</span><span class="p">[</span><span class="n">g</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="o">++</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">;</span>  <span class="c1">// 括号序</span>
<span class="p">}</span>

<span class="kr">inline</span> <span class="kt">void</span> <span class="nf">swap</span><span class="p">(</span><span class="kt">int</span> <span class="o">&amp;</span><span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="o">&amp;</span><span class="n">y</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">t</span><span class="p">;</span>
  <span class="n">t</span> <span class="o">=</span> <span class="n">x</span><span class="p">;</span>
  <span class="n">x</span> <span class="o">=</span> <span class="n">y</span><span class="p">;</span>
  <span class="n">y</span> <span class="o">=</span> <span class="n">t</span><span class="p">;</span>
<span class="p">}</span>

<span class="kr">inline</span> <span class="kt">int</span> <span class="nf">lca</span><span class="p">(</span><span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="n">y</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">dep</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">dep</span><span class="p">[</span><span class="n">y</span><span class="p">])</span> <span class="n">swap</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">dep</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">!=</span> <span class="n">dep</span><span class="p">[</span><span class="n">y</span><span class="p">])</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">dis</span> <span class="o">=</span> <span class="n">dep</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">-</span> <span class="n">dep</span><span class="p">[</span><span class="n">y</span><span class="p">];</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">dis</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">))</span> <span class="n">dis</span> <span class="o">-=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span> <span class="o">=</span> <span class="n">fa</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="n">i</span><span class="p">];</span>
  <span class="p">}</span>  <span class="c1">// 爬到同一高度</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">x</span> <span class="o">==</span> <span class="n">y</span><span class="p">)</span> <span class="k">return</span> <span class="n">x</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">fa</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="n">fa</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="n">i</span><span class="p">])</span> <span class="n">x</span> <span class="o">=</span> <span class="n">fa</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">y</span> <span class="o">=</span> <span class="n">fa</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="n">i</span><span class="p">];</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">fa</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="mi">0</span><span class="p">];</span>
<span class="p">}</span>

<span class="kr">inline</span> <span class="kt">void</span> <span class="nf">add</span><span class="p">(</span><span class="kt">int</span> <span class="n">x</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">vis</span><span class="p">[</span><span class="n">x</span><span class="p">])</span>
    <span class="n">cur</span> <span class="o">-=</span> <span class="p">(</span><span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">v</span><span class="p">[</span><span class="n">col</span><span class="p">[</span><span class="n">x</span><span class="p">]]</span> <span class="o">*</span> <span class="n">w</span><span class="p">[</span><span class="n">app</span><span class="p">[</span><span class="n">col</span><span class="p">[</span><span class="n">x</span><span class="p">]]</span><span class="o">--</span><span class="p">];</span>
  <span class="k">else</span>
    <span class="n">cur</span> <span class="o">+=</span> <span class="p">(</span><span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">v</span><span class="p">[</span><span class="n">col</span><span class="p">[</span><span class="n">x</span><span class="p">]]</span> <span class="o">*</span> <span class="n">w</span><span class="p">[</span><span class="o">++</span><span class="n">app</span><span class="p">[</span><span class="n">col</span><span class="p">[</span><span class="n">x</span><span class="p">]]];</span>
  <span class="n">vis</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">^=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="kr">inline</span> <span class="kt">void</span> <span class="nf">modify</span><span class="p">(</span><span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="n">t</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">vis</span><span class="p">[</span><span class="n">x</span><span class="p">])</span> <span class="p">{</span>
    <span class="n">add</span><span class="p">(</span><span class="n">x</span><span class="p">);</span>
    <span class="n">col</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="n">t</span><span class="p">;</span>
    <span class="n">add</span><span class="p">(</span><span class="n">x</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span>
    <span class="n">col</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="n">t</span><span class="p">;</span>
<span class="p">}</span>  <span class="c1">// 在时间维上移动</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">scanf</span><span class="p">(</span><span class="s">&quot;%d%d%d&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">n</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">m</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">q</span><span class="p">);</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">m</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="n">scanf</span><span class="p">(</span><span class="s">&quot;%d&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">n</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="n">scanf</span><span class="p">(</span><span class="s">&quot;%d&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">w</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">;</span>
    <span class="n">scanf</span><span class="p">(</span><span class="s">&quot;%d%d&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">x</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">y</span><span class="p">);</span>
    <span class="n">addedge</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">);</span>
    <span class="n">addedge</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">n</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">scanf</span><span class="p">(</span><span class="s">&quot;%d&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">last</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
    <span class="n">col</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">last</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
  <span class="p">}</span>
  <span class="n">dfs</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;=</span> <span class="mi">20</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">n</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
      <span class="n">fa</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">fa</span><span class="p">[</span><span class="n">fa</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]][</span><span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>  <span class="c1">// 预处理祖先</span>
  <span class="kt">int</span> <span class="n">block</span> <span class="o">=</span> <span class="n">pow</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="mf">2.0</span> <span class="o">/</span> <span class="mi">3</span><span class="p">);</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">index</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">pos</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">block</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">while</span> <span class="p">(</span><span class="n">q</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">opt</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">;</span>
    <span class="n">scanf</span><span class="p">(</span><span class="s">&quot;%d%d%d&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">opt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">x</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">y</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">opt</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">b</span><span class="p">[</span><span class="o">++</span><span class="n">cnt2</span><span class="p">].</span><span class="n">l</span> <span class="o">=</span> <span class="n">x</span><span class="p">;</span>
      <span class="n">b</span><span class="p">[</span><span class="n">cnt2</span><span class="p">].</span><span class="n">r</span> <span class="o">=</span> <span class="n">last</span><span class="p">[</span><span class="n">x</span><span class="p">];</span>
      <span class="n">last</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="n">cnt2</span><span class="p">].</span><span class="n">t</span> <span class="o">=</span> <span class="n">y</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">f</span><span class="p">[</span><span class="n">y</span><span class="p">])</span> <span class="n">swap</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">);</span>
      <span class="n">a</span><span class="p">[</span><span class="o">++</span><span class="n">cnt1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">query</span><span class="p">){</span><span class="n">lca</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="o">==</span> <span class="n">x</span> <span class="o">?</span> <span class="n">f</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">:</span> <span class="n">g</span><span class="p">[</span><span class="n">x</span><span class="p">],</span> <span class="n">f</span><span class="p">[</span><span class="n">y</span><span class="p">],</span> <span class="n">cnt2</span><span class="p">,</span> <span class="n">cnt1</span><span class="p">};</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="n">sort</span><span class="p">(</span><span class="n">a</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">a</span> <span class="o">+</span> <span class="n">cnt1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
  <span class="kt">int</span> <span class="n">L</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="n">T</span><span class="p">;</span>  <span class="c1">// 指针坐标</span>
  <span class="n">L</span> <span class="o">=</span> <span class="n">R</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">T</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">cnt1</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">T</span> <span class="o">&lt;=</span> <span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">t</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">modify</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="n">T</span><span class="p">].</span><span class="n">l</span><span class="p">,</span> <span class="n">b</span><span class="p">[</span><span class="n">T</span><span class="p">].</span><span class="n">t</span><span class="p">);</span>
      <span class="n">T</span><span class="o">++</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">T</span> <span class="o">&gt;</span> <span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">t</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">modify</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="n">T</span><span class="p">].</span><span class="n">l</span><span class="p">,</span> <span class="n">b</span><span class="p">[</span><span class="n">T</span><span class="p">].</span><span class="n">r</span><span class="p">);</span>
      <span class="n">T</span><span class="o">--</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">L</span> <span class="o">&gt;</span> <span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">l</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">L</span><span class="o">--</span><span class="p">;</span>
      <span class="n">add</span><span class="p">(</span><span class="n">id</span><span class="p">[</span><span class="n">L</span><span class="p">]);</span>
    <span class="p">}</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">L</span> <span class="o">&lt;</span> <span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">l</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">add</span><span class="p">(</span><span class="n">id</span><span class="p">[</span><span class="n">L</span><span class="p">]);</span>
      <span class="n">L</span><span class="o">++</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">R</span> <span class="o">&gt;</span> <span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">add</span><span class="p">(</span><span class="n">id</span><span class="p">[</span><span class="n">R</span><span class="p">]);</span>
      <span class="n">R</span><span class="o">--</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">R</span> <span class="o">&lt;</span> <span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">R</span><span class="o">++</span><span class="p">;</span>
      <span class="n">add</span><span class="p">(</span><span class="n">id</span><span class="p">[</span><span class="n">R</span><span class="p">]);</span>
    <span class="p">}</span>
    <span class="kt">int</span> <span class="n">x</span> <span class="o">=</span> <span class="n">id</span><span class="p">[</span><span class="n">L</span><span class="p">],</span> <span class="n">y</span> <span class="o">=</span> <span class="n">id</span><span class="p">[</span><span class="n">R</span><span class="p">];</span>
    <span class="kt">int</span> <span class="n">llca</span> <span class="o">=</span> <span class="n">lca</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">x</span> <span class="o">!=</span> <span class="n">llca</span> <span class="o">&amp;&amp;</span> <span class="n">y</span> <span class="o">!=</span> <span class="n">llca</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">add</span><span class="p">(</span><span class="n">llca</span><span class="p">);</span>
      <span class="n">ans</span><span class="p">[</span><span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">cur</span><span class="p">;</span>
      <span class="n">add</span><span class="p">(</span><span class="n">llca</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span>
      <span class="n">ans</span><span class="p">[</span><span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">cur</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">cnt1</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%lld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ans</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>

<h2 id="_14">真·树上莫队<a class="headerlink" href="#_14" title="Permanent link">&para;</a></h2>
<p>上面的树上莫队只是将树转化成了链，下面的才是真正的树上莫队</p>
<p><del>（由于莫队都是板子题，所以实现部分不做太多解释）</del></p>
<h3 id="_15">询问的排序<a class="headerlink" href="#_15" title="Permanent link">&para;</a></h3>
<p>首先我们知道莫队的是基于分块的算法，所以我们需要找到一种树上的分块方法来保证时间复杂度</p>
<p>条件：</p>
<ul>
<li>属于同一块的节点之间的距离不超过给定块的大小</li>
<li>每个块中的节点不能太多也不能太少</li>
<li>每个节点都要属于一个块</li>
<li>编号相邻的块之间的距离不能太大</li>
</ul>
<p>了解了这些条件后，我们看到这样一道题<a href="https://www.lydsy.com/JudgeOnline/problem.php?id=1086">[SCOI2005]王室联邦</a></p>
<p>在这道题的基础上我们只要保证最后一个条件就可以解决分块的问题了</p>
<div class="admonition 思路">
<p class="admonition-title">思路</p>
<p>令 lim 为希望块的大小，首先，对于整个树 dfs，当子树的大小大于 lim 时，就将它们分在一块，容易想到：对于根，可能会剩下一些点，于是将这些点分在最后一个块里</p>
</div>
<p>做法：用栈维护当前节点作为父节点访问它的子节点，当从栈顶到父节点的距离大于希望块的大小时，弹出这部分元素分为一块，最后剩余的一块单独作为一块</p>
<p>最后的排序方法：若第一维时间戳大于第二维，交换它们，按第一维所属块为第一关键字，第二维时间戳为第二关键字排序</p>
<h3 id="_16">指针的移动<a class="headerlink" href="#_16" title="Permanent link">&para;</a></h3>
<p>容易想到，我们可以标记被计入答案的点，让指针直接向目标移动，同时取反路径上的点</p>
<p>但是，这样有一个问题，若指针一开始都在 x 上，显然 x 被标记，当两个指针向同一子节点移动（还有许多情况）时，x 应该不被标记，但实际情况是 x 被标记，因为两个指针分别标记了一次，抵消了</p>
<p>如何解决呢？</p>
<p>有一个很显然的性质：这些点肯定是某些 LCA，因为 LCA 处才有可能被重复撤销导致撤销失败</p>
<p>所以我们每次不标记 LCA，到需要询问答案时再将 LCA 标记，然后再撤销</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="c1">//取反路径上除LCA以外的所有节点</span>
<span class="kt">void</span> <span class="nf">move</span><span class="p">(</span><span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="n">y</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">dp</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">dp</span><span class="p">[</span><span class="n">y</span><span class="p">])</span> <span class="n">swap</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">);</span>
  <span class="k">while</span> <span class="p">(</span><span class="n">dp</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">dp</span><span class="p">[</span><span class="n">y</span><span class="p">])</span> <span class="n">update</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">x</span> <span class="o">=</span> <span class="n">fa</span><span class="p">[</span><span class="n">x</span><span class="p">];</span>
  <span class="k">while</span> <span class="p">(</span><span class="n">x</span> <span class="o">!=</span> <span class="n">y</span><span class="p">)</span> <span class="n">update</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">update</span><span class="p">(</span><span class="n">y</span><span class="p">),</span> <span class="n">x</span> <span class="o">=</span> <span class="n">fa</span><span class="p">[</span><span class="n">x</span><span class="p">],</span> <span class="n">y</span> <span class="o">=</span> <span class="n">fa</span><span class="p">[</span><span class="n">y</span><span class="p">];</span>
  <span class="c1">// x!=y保证LCA没被取反</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>

<p>对于求 LCA，我们可以用树剖，然后我们就可以把分块的步骤放到树剖的第一次 dfs 里面，时间戳也可以直接用第二次 dfs 的 dfs 序~~（如果你用 tarjan 就当我没说）~~</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="kt">int</span> <span class="n">bl</span><span class="p">[</span><span class="mi">100002</span><span class="p">],</span> <span class="n">bls</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>  <span class="c1">//属于的块，块的数量</span>
<span class="kt">unsigned</span> <span class="n">step</span><span class="p">;</span>            <span class="c1">//块大小</span>
<span class="kt">int</span> <span class="n">fa</span><span class="p">[</span><span class="mi">100002</span><span class="p">],</span> <span class="n">dp</span><span class="p">[</span><span class="mi">100002</span><span class="p">],</span> <span class="n">hs</span><span class="p">[</span><span class="mi">100002</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">},</span> <span class="n">sz</span><span class="p">[</span><span class="mi">100002</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
<span class="c1">//父节点，深度，重儿子，大小</span>
<span class="n">stack</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">sta</span><span class="p">;</span>
<span class="kt">void</span> <span class="nf">dfs1</span><span class="p">(</span><span class="kt">int</span> <span class="n">x</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">sz</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="n">ss</span> <span class="o">=</span> <span class="n">sta</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">head</span><span class="p">[</span><span class="n">x</span><span class="p">];</span> <span class="n">i</span><span class="p">;</span> <span class="n">i</span> <span class="o">=</span> <span class="n">nxt</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ver</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="n">fa</span><span class="p">[</span><span class="n">x</span><span class="p">])</span> <span class="p">{</span>
      <span class="n">fa</span><span class="p">[</span><span class="n">ver</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="n">x</span><span class="p">;</span>
      <span class="n">dp</span><span class="p">[</span><span class="n">ver</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="n">dp</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
      <span class="n">dfs1</span><span class="p">(</span><span class="n">ver</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
      <span class="n">sz</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">+=</span> <span class="n">sz</span><span class="p">[</span><span class="n">ver</span><span class="p">[</span><span class="n">i</span><span class="p">]];</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">sz</span><span class="p">[</span><span class="n">ver</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">&gt;</span> <span class="n">sz</span><span class="p">[</span><span class="n">hs</span><span class="p">[</span><span class="n">x</span><span class="p">]])</span> <span class="n">hs</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="n">ver</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">sta</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">-</span> <span class="n">ss</span> <span class="o">&gt;=</span> <span class="n">step</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">bls</span><span class="o">++</span><span class="p">;</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">sta</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">!=</span> <span class="n">ss</span><span class="p">)</span> <span class="n">bl</span><span class="p">[</span><span class="n">sta</span><span class="p">.</span><span class="n">top</span><span class="p">()]</span> <span class="o">=</span> <span class="n">bls</span><span class="p">,</span> <span class="n">sta</span><span class="p">.</span><span class="n">pop</span><span class="p">();</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="n">sta</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">x</span><span class="p">);</span>
<span class="p">}</span>
<span class="c1">// main</span>
<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sta</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span> <span class="p">{</span>
  <span class="n">bls</span><span class="o">++</span><span class="p">;</span>  <span class="c1">//这一行可写可不写</span>
  <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">sta</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span> <span class="n">bl</span><span class="p">[</span><span class="n">sta</span><span class="p">.</span><span class="n">top</span><span class="p">()]</span> <span class="o">=</span> <span class="n">bls</span><span class="p">,</span> <span class="n">sta</span><span class="p">.</span><span class="n">pop</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>

<h3 id="_17">时间复杂度<a class="headerlink" href="#_17" title="Permanent link">&para;</a></h3>
<p>重点到了，这里关系到块的大小取值</p>
<p>设块的大小为 unit</p>
<p>对于 x 指针，由于每个块中节点的距离在 unit 左右，每个块中 x 指针移动 <span><span class="MathJax_Preview">unit^2</span><script type="math/tex">unit^2</script></span> 次（ <span><span class="MathJax_Preview">unit\times dis_max</span><script type="math/tex">unit\times dis_max</script></span> ），共计 <span><span class="MathJax_Preview">n\times unit</span><script type="math/tex">n\times unit</script></span> （ <span><span class="MathJax_Preview">unit^2 \times (n\div unit)</span><script type="math/tex">unit^2 \times (n\div unit)</script></span> ）次</p>
<p>对于 y 指针，每个块中最多移动 O（n）次，共计 <span><span class="MathJax_Preview">n^2\div unit</span><script type="math/tex">n^2\div unit</script></span> （ <span><span class="MathJax_Preview">n \times (n \div unit)</span><script type="math/tex">n \times (n \div unit)</script></span> ）次</p>
<p>加起来大概在根号处取得最小值（由于树上莫队块的大小不固定，所以不一定要严格按照）</p>
<h3 id="wc2013">[WC2013]糖果公园<a class="headerlink" href="#wc2013" title="Permanent link">&para;</a></h3>
<p>由于多了时间维，块的大小取到 0.6 的样子就差不多了</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;bits/stdc++.h&gt;</span><span class="cp"></span>
<span class="c1">//#pragma GCC optimize(2)</span>
<span class="k">using</span> <span class="k">namespace</span> <span class="n">std</span><span class="p">;</span>
<span class="kr">inline</span> <span class="kt">int</span> <span class="nf">gi</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">register</span> <span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">op</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="k">while</span> <span class="p">(</span><span class="n">c</span> <span class="o">=</span> <span class="n">getchar</span><span class="p">(),</span> <span class="n">c</span> <span class="o">&lt;</span> <span class="sc">&#39;0&#39;</span> <span class="o">||</span> <span class="n">c</span> <span class="o">&gt;</span> <span class="sc">&#39;9&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;-&#39;</span><span class="p">)</span> <span class="n">op</span> <span class="o">=</span> <span class="o">-</span><span class="n">op</span><span class="p">;</span>
  <span class="n">x</span> <span class="o">=</span> <span class="n">c</span> <span class="o">^</span> <span class="mi">48</span><span class="p">;</span>
  <span class="k">while</span> <span class="p">(</span><span class="n">c</span> <span class="o">=</span> <span class="n">getchar</span><span class="p">(),</span> <span class="n">c</span> <span class="o">&gt;=</span> <span class="sc">&#39;0&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">c</span> <span class="o">&lt;=</span> <span class="sc">&#39;9&#39;</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">x</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">c</span> <span class="o">^</span> <span class="mi">48</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">x</span> <span class="o">*</span> <span class="n">op</span><span class="p">;</span>
<span class="p">}</span>
<span class="kt">int</span> <span class="n">head</span><span class="p">[</span><span class="mi">100002</span><span class="p">],</span> <span class="n">nxt</span><span class="p">[</span><span class="mi">200004</span><span class="p">],</span> <span class="n">ver</span><span class="p">[</span><span class="mi">200004</span><span class="p">],</span> <span class="n">tot</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="kt">void</span> <span class="nf">add</span><span class="p">(</span><span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="n">y</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">ver</span><span class="p">[</span><span class="o">++</span><span class="n">tot</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span><span class="p">,</span> <span class="n">nxt</span><span class="p">[</span><span class="n">tot</span><span class="p">]</span> <span class="o">=</span> <span class="n">head</span><span class="p">[</span><span class="n">x</span><span class="p">],</span> <span class="n">head</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="n">tot</span><span class="p">;</span>
  <span class="n">ver</span><span class="p">[</span><span class="o">++</span><span class="n">tot</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">,</span> <span class="n">nxt</span><span class="p">[</span><span class="n">tot</span><span class="p">]</span> <span class="o">=</span> <span class="n">head</span><span class="p">[</span><span class="n">y</span><span class="p">],</span> <span class="n">head</span><span class="p">[</span><span class="n">y</span><span class="p">]</span> <span class="o">=</span> <span class="n">tot</span><span class="p">;</span>
<span class="p">}</span>
<span class="kt">int</span> <span class="n">bl</span><span class="p">[</span><span class="mi">100002</span><span class="p">],</span> <span class="n">bls</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="kt">unsigned</span> <span class="n">step</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">fa</span><span class="p">[</span><span class="mi">100002</span><span class="p">],</span> <span class="n">dp</span><span class="p">[</span><span class="mi">100002</span><span class="p">],</span> <span class="n">hs</span><span class="p">[</span><span class="mi">100002</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">},</span> <span class="n">sz</span><span class="p">[</span><span class="mi">100002</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">},</span> <span class="n">top</span><span class="p">[</span><span class="mi">100002</span><span class="p">],</span>
                            <span class="n">id</span><span class="p">[</span><span class="mi">100002</span><span class="p">];</span>
<span class="n">stack</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">sta</span><span class="p">;</span>
<span class="kt">void</span> <span class="nf">dfs1</span><span class="p">(</span><span class="kt">int</span> <span class="n">x</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">sz</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="n">ss</span> <span class="o">=</span> <span class="n">sta</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">head</span><span class="p">[</span><span class="n">x</span><span class="p">];</span> <span class="n">i</span><span class="p">;</span> <span class="n">i</span> <span class="o">=</span> <span class="n">nxt</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ver</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="n">fa</span><span class="p">[</span><span class="n">x</span><span class="p">])</span> <span class="p">{</span>
      <span class="n">fa</span><span class="p">[</span><span class="n">ver</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="n">x</span><span class="p">,</span> <span class="n">dp</span><span class="p">[</span><span class="n">ver</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="n">dp</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
      <span class="n">dfs1</span><span class="p">(</span><span class="n">ver</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
      <span class="n">sz</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">+=</span> <span class="n">sz</span><span class="p">[</span><span class="n">ver</span><span class="p">[</span><span class="n">i</span><span class="p">]];</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">sz</span><span class="p">[</span><span class="n">ver</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">&gt;</span> <span class="n">sz</span><span class="p">[</span><span class="n">hs</span><span class="p">[</span><span class="n">x</span><span class="p">]])</span> <span class="n">hs</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="n">ver</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">sta</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">-</span> <span class="n">ss</span> <span class="o">&gt;=</span> <span class="n">step</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">bls</span><span class="o">++</span><span class="p">;</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">sta</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">!=</span> <span class="n">ss</span><span class="p">)</span> <span class="n">bl</span><span class="p">[</span><span class="n">sta</span><span class="p">.</span><span class="n">top</span><span class="p">()]</span> <span class="o">=</span> <span class="n">bls</span><span class="p">,</span> <span class="n">sta</span><span class="p">.</span><span class="n">pop</span><span class="p">();</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="n">sta</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">x</span><span class="p">);</span>
<span class="p">}</span>
<span class="kt">int</span> <span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="kt">void</span> <span class="nf">dfs2</span><span class="p">(</span><span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="n">hf</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">top</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="n">hf</span><span class="p">,</span> <span class="n">id</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="o">++</span><span class="n">cnt</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hs</span><span class="p">[</span><span class="n">x</span><span class="p">])</span> <span class="k">return</span><span class="p">;</span>
  <span class="n">dfs2</span><span class="p">(</span><span class="n">hs</span><span class="p">[</span><span class="n">x</span><span class="p">],</span> <span class="n">hf</span><span class="p">);</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">head</span><span class="p">[</span><span class="n">x</span><span class="p">];</span> <span class="n">i</span><span class="p">;</span> <span class="n">i</span> <span class="o">=</span> <span class="n">nxt</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ver</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="n">fa</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="n">ver</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="n">hs</span><span class="p">[</span><span class="n">x</span><span class="p">])</span> <span class="n">dfs2</span><span class="p">(</span><span class="n">ver</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">ver</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="p">}</span>
<span class="kt">int</span> <span class="nf">lca</span><span class="p">(</span><span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="n">y</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">while</span> <span class="p">(</span><span class="n">top</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">!=</span> <span class="n">top</span><span class="p">[</span><span class="n">y</span><span class="p">])</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">dp</span><span class="p">[</span><span class="n">top</span><span class="p">[</span><span class="n">x</span><span class="p">]]</span> <span class="o">&lt;</span> <span class="n">dp</span><span class="p">[</span><span class="n">top</span><span class="p">[</span><span class="n">y</span><span class="p">]])</span> <span class="n">swap</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">);</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">fa</span><span class="p">[</span><span class="n">top</span><span class="p">[</span><span class="n">x</span><span class="p">]];</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">dp</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">dp</span><span class="p">[</span><span class="n">y</span><span class="p">]</span> <span class="o">?</span> <span class="nl">x</span> <span class="p">:</span> <span class="n">y</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">struct</span> <span class="n">qu</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">id</span><span class="p">;</span>
  <span class="kt">bool</span> <span class="k">operator</span><span class="o">&lt;</span><span class="p">(</span><span class="k">const</span> <span class="n">qu</span> <span class="n">a</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">bl</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">==</span> <span class="n">bl</span><span class="p">[</span><span class="n">a</span><span class="p">.</span><span class="n">x</span><span class="p">]</span> <span class="o">?</span> <span class="p">(</span><span class="n">bl</span><span class="p">[</span><span class="n">y</span><span class="p">]</span> <span class="o">==</span> <span class="n">bl</span><span class="p">[</span><span class="n">a</span><span class="p">.</span><span class="n">y</span><span class="p">]</span> <span class="o">?</span> <span class="n">t</span> <span class="o">&lt;</span> <span class="n">a</span><span class="p">.</span><span class="nl">t</span> <span class="p">:</span> <span class="n">bl</span><span class="p">[</span><span class="n">y</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">bl</span><span class="p">[</span><span class="n">a</span><span class="p">.</span><span class="n">y</span><span class="p">])</span>
                            <span class="o">:</span> <span class="n">bl</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">bl</span><span class="p">[</span><span class="n">a</span><span class="p">.</span><span class="n">x</span><span class="p">];</span>
  <span class="p">}</span>
<span class="p">}</span> <span class="n">q</span><span class="p">[</span><span class="mi">100001</span><span class="p">];</span>
<span class="kt">int</span> <span class="n">qs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">struct</span> <span class="n">ch</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">b</span><span class="p">;</span>
<span class="p">}</span> <span class="n">upd</span><span class="p">[</span><span class="mi">100001</span><span class="p">];</span>
<span class="kt">int</span> <span class="n">ups</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="kt">long</span> <span class="kt">long</span> <span class="n">ans</span><span class="p">[</span><span class="mi">100001</span><span class="p">];</span>
<span class="kt">int</span> <span class="n">b</span><span class="p">[</span><span class="mi">100001</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
<span class="kt">int</span> <span class="n">a</span><span class="p">[</span><span class="mi">100001</span><span class="p">];</span>
<span class="kt">long</span> <span class="kt">long</span> <span class="n">w</span><span class="p">[</span><span class="mi">100001</span><span class="p">];</span>
<span class="kt">long</span> <span class="kt">long</span> <span class="n">v</span><span class="p">[</span><span class="mi">100001</span><span class="p">];</span>
<span class="kt">long</span> <span class="kt">long</span> <span class="n">now</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="kt">bool</span> <span class="n">vis</span><span class="p">[</span><span class="mi">100001</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
<span class="kt">void</span> <span class="nf">back</span><span class="p">(</span><span class="kt">int</span> <span class="n">t</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">vis</span><span class="p">[</span><span class="n">upd</span><span class="p">[</span><span class="n">t</span><span class="p">].</span><span class="n">x</span><span class="p">])</span> <span class="p">{</span>
    <span class="n">now</span> <span class="o">-=</span> <span class="n">w</span><span class="p">[</span><span class="n">b</span><span class="p">[</span><span class="n">upd</span><span class="p">[</span><span class="n">t</span><span class="p">].</span><span class="n">y</span><span class="p">]</span><span class="o">--</span><span class="p">]</span> <span class="o">*</span> <span class="n">v</span><span class="p">[</span><span class="n">upd</span><span class="p">[</span><span class="n">t</span><span class="p">].</span><span class="n">y</span><span class="p">];</span>
    <span class="n">now</span> <span class="o">+=</span> <span class="n">w</span><span class="p">[</span><span class="o">++</span><span class="n">b</span><span class="p">[</span><span class="n">upd</span><span class="p">[</span><span class="n">t</span><span class="p">].</span><span class="n">b</span><span class="p">]]</span> <span class="o">*</span> <span class="n">v</span><span class="p">[</span><span class="n">upd</span><span class="p">[</span><span class="n">t</span><span class="p">].</span><span class="n">b</span><span class="p">];</span>
  <span class="p">}</span>
  <span class="n">a</span><span class="p">[</span><span class="n">upd</span><span class="p">[</span><span class="n">t</span><span class="p">].</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="n">upd</span><span class="p">[</span><span class="n">t</span><span class="p">].</span><span class="n">b</span><span class="p">;</span>
<span class="p">}</span>
<span class="kt">void</span> <span class="nf">change</span><span class="p">(</span><span class="kt">int</span> <span class="n">t</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">vis</span><span class="p">[</span><span class="n">upd</span><span class="p">[</span><span class="n">t</span><span class="p">].</span><span class="n">x</span><span class="p">])</span> <span class="p">{</span>
    <span class="n">now</span> <span class="o">-=</span> <span class="n">w</span><span class="p">[</span><span class="n">b</span><span class="p">[</span><span class="n">upd</span><span class="p">[</span><span class="n">t</span><span class="p">].</span><span class="n">b</span><span class="p">]</span><span class="o">--</span><span class="p">]</span> <span class="o">*</span> <span class="n">v</span><span class="p">[</span><span class="n">upd</span><span class="p">[</span><span class="n">t</span><span class="p">].</span><span class="n">b</span><span class="p">];</span>
    <span class="n">now</span> <span class="o">+=</span> <span class="n">w</span><span class="p">[</span><span class="o">++</span><span class="n">b</span><span class="p">[</span><span class="n">upd</span><span class="p">[</span><span class="n">t</span><span class="p">].</span><span class="n">y</span><span class="p">]]</span> <span class="o">*</span> <span class="n">v</span><span class="p">[</span><span class="n">upd</span><span class="p">[</span><span class="n">t</span><span class="p">].</span><span class="n">y</span><span class="p">];</span>
  <span class="p">}</span>
  <span class="n">a</span><span class="p">[</span><span class="n">upd</span><span class="p">[</span><span class="n">t</span><span class="p">].</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="n">upd</span><span class="p">[</span><span class="n">t</span><span class="p">].</span><span class="n">y</span><span class="p">;</span>
<span class="p">}</span>
<span class="kt">void</span> <span class="nf">update</span><span class="p">(</span><span class="kt">int</span> <span class="n">x</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">vis</span><span class="p">[</span><span class="n">x</span><span class="p">])</span>
    <span class="n">now</span> <span class="o">-=</span> <span class="n">w</span><span class="p">[</span><span class="n">b</span><span class="p">[</span><span class="n">a</span><span class="p">[</span><span class="n">x</span><span class="p">]]</span><span class="o">--</span><span class="p">]</span> <span class="o">*</span> <span class="n">v</span><span class="p">[</span><span class="n">a</span><span class="p">[</span><span class="n">x</span><span class="p">]];</span>
  <span class="k">else</span>
    <span class="n">now</span> <span class="o">+=</span> <span class="n">w</span><span class="p">[</span><span class="o">++</span><span class="n">b</span><span class="p">[</span><span class="n">a</span><span class="p">[</span><span class="n">x</span><span class="p">]]]</span> <span class="o">*</span> <span class="n">v</span><span class="p">[</span><span class="n">a</span><span class="p">[</span><span class="n">x</span><span class="p">]];</span>
  <span class="n">vis</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">^=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="kt">void</span> <span class="nf">move</span><span class="p">(</span><span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="n">y</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">dp</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">dp</span><span class="p">[</span><span class="n">y</span><span class="p">])</span> <span class="n">swap</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">);</span>
  <span class="k">while</span> <span class="p">(</span><span class="n">dp</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">dp</span><span class="p">[</span><span class="n">y</span><span class="p">])</span> <span class="n">update</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">x</span> <span class="o">=</span> <span class="n">fa</span><span class="p">[</span><span class="n">x</span><span class="p">];</span>
  <span class="k">while</span> <span class="p">(</span><span class="n">x</span> <span class="o">!=</span> <span class="n">y</span><span class="p">)</span> <span class="n">update</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">update</span><span class="p">(</span><span class="n">y</span><span class="p">),</span> <span class="n">x</span> <span class="o">=</span> <span class="n">fa</span><span class="p">[</span><span class="n">x</span><span class="p">],</span> <span class="n">y</span> <span class="o">=</span> <span class="n">fa</span><span class="p">[</span><span class="n">y</span><span class="p">];</span>
<span class="p">}</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">n</span> <span class="o">=</span> <span class="n">gi</span><span class="p">(),</span> <span class="n">m</span> <span class="o">=</span> <span class="n">gi</span><span class="p">(),</span> <span class="n">k</span> <span class="o">=</span> <span class="n">gi</span><span class="p">();</span>
  <span class="n">step</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">pow</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">);</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">m</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">gi</span><span class="p">();</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">n</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="n">w</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">gi</span><span class="p">();</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="n">add</span><span class="p">(</span><span class="n">gi</span><span class="p">(),</span> <span class="n">gi</span><span class="p">());</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">n</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">gi</span><span class="p">();</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">k</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">gi</span><span class="p">())</span>
      <span class="n">q</span><span class="p">[</span><span class="o">++</span><span class="n">qs</span><span class="p">].</span><span class="n">x</span> <span class="o">=</span> <span class="n">gi</span><span class="p">(),</span> <span class="n">q</span><span class="p">[</span><span class="n">qs</span><span class="p">].</span><span class="n">y</span> <span class="o">=</span> <span class="n">gi</span><span class="p">(),</span> <span class="n">q</span><span class="p">[</span><span class="n">qs</span><span class="p">].</span><span class="n">t</span> <span class="o">=</span> <span class="n">ups</span><span class="p">,</span> <span class="n">q</span><span class="p">[</span><span class="n">qs</span><span class="p">].</span><span class="n">id</span> <span class="o">=</span> <span class="n">qs</span><span class="p">;</span>
    <span class="k">else</span>
      <span class="n">upd</span><span class="p">[</span><span class="o">++</span><span class="n">ups</span><span class="p">].</span><span class="n">x</span> <span class="o">=</span> <span class="n">gi</span><span class="p">(),</span> <span class="n">upd</span><span class="p">[</span><span class="n">ups</span><span class="p">].</span><span class="n">y</span> <span class="o">=</span> <span class="n">gi</span><span class="p">();</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">ups</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="n">upd</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">b</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="n">upd</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">x</span><span class="p">],</span> <span class="n">a</span><span class="p">[</span><span class="n">upd</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="n">upd</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">y</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">ups</span><span class="p">;</span> <span class="n">i</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="n">back</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
  <span class="n">fa</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="n">dfs1</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">dfs2</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sta</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span> <span class="p">{</span>
    <span class="n">bls</span><span class="o">++</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">sta</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span> <span class="n">bl</span><span class="p">[</span><span class="n">sta</span><span class="p">.</span><span class="n">top</span><span class="p">()]</span> <span class="o">=</span> <span class="n">bls</span><span class="p">,</span> <span class="n">sta</span><span class="p">.</span><span class="n">pop</span><span class="p">();</span>
  <span class="p">}</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">n</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">id</span><span class="p">[</span><span class="n">q</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">x</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">id</span><span class="p">[</span><span class="n">q</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">y</span><span class="p">])</span> <span class="n">swap</span><span class="p">(</span><span class="n">q</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">x</span><span class="p">,</span> <span class="n">q</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">y</span><span class="p">);</span>
  <span class="n">sort</span><span class="p">(</span><span class="n">q</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">q</span> <span class="o">+</span> <span class="n">qs</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
  <span class="kt">int</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">t</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">qs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">x</span> <span class="o">!=</span> <span class="n">q</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">x</span><span class="p">)</span> <span class="n">move</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">q</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">x</span><span class="p">),</span> <span class="n">x</span> <span class="o">=</span> <span class="n">q</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">x</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">y</span> <span class="o">!=</span> <span class="n">q</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">y</span><span class="p">)</span> <span class="n">move</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">q</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">y</span><span class="p">),</span> <span class="n">y</span> <span class="o">=</span> <span class="n">q</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">y</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">f</span> <span class="o">=</span> <span class="n">lca</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">);</span>
    <span class="n">update</span><span class="p">(</span><span class="n">f</span><span class="p">);</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">t</span> <span class="o">&lt;</span> <span class="n">q</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">t</span><span class="p">)</span> <span class="n">change</span><span class="p">(</span><span class="o">++</span><span class="n">t</span><span class="p">);</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">t</span> <span class="o">&gt;</span> <span class="n">q</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">t</span><span class="p">)</span> <span class="n">back</span><span class="p">(</span><span class="n">t</span><span class="o">--</span><span class="p">);</span>
    <span class="n">ans</span><span class="p">[</span><span class="n">q</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">now</span><span class="p">;</span>
    <span class="n">update</span><span class="p">(</span><span class="n">f</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">qs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%lld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ans</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
                
                  
                
              
              
                


  <h2 id="__comments">评论</h2>
  <div id="disqus_thread"></div>
  <script>
    var disqus_config = function () {
      this.page.url = "https://hai5g.cn/aiwiki/misc/mo-algo/";
      this.page.identifier =
        "/misc/mo-algo/";
    };
    (function() {
      var d = document, s = d.createElement("script");
      s.src = "//AI-Wiki.disqus.com/embed.js";
      s.setAttribute("data-timestamp", +new Date());
      (d.head || d.body).appendChild(s);
    })();
  </script>

              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../cdq-divide/" title="CDQ 分治" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  后退
                </span>
                CDQ 分治
              </span>
            </div>
          </a>
        
        
          <a href="../fractional-programming/" title="分数规划" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  前进
                </span>
                分数规划
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            Copyright &copy; 2019 AI Wiki Team
          </div>
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../assets/javascripts/application.39abc4af.js"></script>
      
        
        
          
          <script src="../../assets/javascripts/lunr/lunr.stemmer.support.js"></script>
          
            
              
              
            
          
          
        
      
      <script>app.initialize({version:"1.0.4",url:{base:"../.."}})</script>
      
        <script src="https://cdn.jsdelivr.net/gh/ethantw/Han@3.3.0/dist/han.min.js"></script>
      
        <script src="../../_static/js/extra.js?v=10"></script>
      
        <script src="https://cdnjs.loli.net/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML"></script>
      
    
  </body>
</html>